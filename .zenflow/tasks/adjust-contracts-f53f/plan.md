# New feature


## Configuration
- **Artifacts Path**: `.zenflow/tasks/{task_id}`
the actual path should be substituted for {@artifacts_path}

---

## Workflow Steps

### [x] Step: Requirements
<!-- chat-id: b24f0ce2-a0ae-4504-aa59-22b955eb347a -->

Your job is to generate a Product Requirements Document based on the feature description,

First, analyze the provided feature definition and determine unclear aspects.  For unclear aspects:
       - Make informed guesses based on context and industry standards
       - Only mark with [NEEDS CLARIFICATION: specific question] if:
         - The choice significantly impacts feature scope or user experience
         - Multiple reasonable interpretations exist with different implications
         - No reasonable default exists
      - Prioritize clarifications by impact: scope > security/privacy > user experience > technical details

Ask up to 5 most priority clarifications to the user. Then, create the document following this template:

```
# Feature Specification: [FEATURE NAME]


## User Stories*


### User Story 1 - [Brief Title]

**Acceptance Scenarios**:

1. **Given** [initial state], **When** [action], **Then** [expected outcome]
2. **Given** [initial state], **When** [action], **Then** [expected outcome]

---

## Requirements*

## Success Criteria*

```

Save the PRD into `{@artifacts_path}/requirements.md`.

### [x] Step: Technical Specification
<!-- chat-id: c1f09283-1ae9-4e72-8d61-d6dcfef78446 -->

Based on the PRD in `{@artifacts_path}/requirements.md`, create a detailed technical specification to be used by a coding agent to implement the feature. Follow this template:

```
# Technical Specification: [FEATURE]

## Technical Context
Language/Version, primary dependencies, etc

## Technical Implementation Brief

Summarize key technical decisions for implementing the feature. Make sure they take into account the existing code as much as possible.

## Source Code Structure

## Contracts

Define addition or changes in data models, DB schemas, APIs, code interfaces etc

## Delivery Phases

Define several incremental deliverables for the feature. Each should be a minimal viable product testable end-to-end.

## Verification Strategy 

Define how the coding agent can verify each deliverable it creates. Provide instructions for the agent to perform the verification using available tools (lint/test commands, bash commands) and create helper scripts and tools for more complex result verification.
The verification for each deliverable should be executable by a coding agent using built-in capabilities (lint and test commands from the project, bash commands), pre-generated helper scripts or MCP servers. Research and add to the spec:

- MCP servers that should be installed to help the agent with the verification 

- helper scripts that need to be generated in the first phases of the plan to verify complex scenarios that can't be covered by the tests in the project's test framework(s)

- any sample input artifact(s) that are required for verification. Note if these artifacts can be a) generated by the agent; b) discovered by the agent on line; c) must be provided by the user.
```

Save the spec to `{@artifacts_path}/spec.md`.

### [x] Step: Implementation Plan
<!-- chat-id: 3c26c94c-ecf0-495f-8c6b-7de62abd9fca -->

Based on the technical spec in `{@artifacts_path}/spec.md`, create a detailed task plan and update `{@artifacts_path}/plan.md`. Each task should have task definition, references to contracts to be used/implemented, deliverable definition and verification instructions.

Format each task as 
```
### [ ] Step: <task_name>
Task instructions
```

"Step:" prefix is important, do not omit it!

---

### [x] Step: Add Ephemeral State Store for Custom Contracts
<!-- chat-id: 6b95cf3e-94df-4954-bb25-5139dd37e1c3 -->
Task definition
- Add in-memory map and API in `docs/roster_cap_tool/js/state.js` to store custom year-by-year contract distributions per player.

Contracts to implement/use
- State shape addition: `state.customContractsByPlayer: { [playerId: string]: { [year: number]: { salary: number, bonus: number } } }`
- Public API (export from `state.js`):
  - `getCustomContract(playerId: string): Record<number, { salary: number, bonus: number }> | null`
  - `setCustomContract(playerId: string, map: Record<number, { salary: number, bonus: number }>): void`
  - `resetCustomContract(playerId: string): void`

Deliverable
- Functions exported from `state.js`, emitting via existing `emit()` on updates. No persistence to localStorage.

Verification
- Open `docs/roster_cap_tool/test.html` in the browser or main app, execute in DevTools console:
  - Call `window.__state = await import('./js/state.js')` then `__state.setCustomContract('p1', { 2026:{salary:22700000,bonus:0} })` and confirm subscribers fire (console debug) and `__state.getCustomContract('p1')` returns the map.
  - Reload page and confirm data is gone (ephemeral only).

### [x] Step: Add Utilities for Years, Defaults, and Formatting
<!-- chat-id: 1d038291-fd97-456e-b9d8-f9bf68975169 -->
Task definition
- Implement helpers for computing start year, default 50/50 distribution, and currency formatting in millions.

Contracts to implement/use
- New util module `docs/roster_cap_tool/js/format.js` (or inline in editor module if preferred by code style):
  - `formatMillions(n: number): string` → `$12.3M` with 1–2 decimals
  - `toAbsoluteDollarsFromMillions(m: number|string): number`
- Add pure helpers (co-located in editor module or separate `contractUtils.js` if desired):
  - `computeStartYear(player)`: uses `getBaseCalendarYear()` and `player.contractLength/contractYearsLeft`
  - `computeDefaultDistribution(player)`: remaining years only; per-year = `(salary+bonus)/length`; salary = bonus = per-year × 0.5

Deliverable
- Exported helpers available for the editor module; unit-free of UI.

Verification
- In DevTools console, create a sample player and verify:
  - `computeStartYear` returns base year aligned with `getBaseCalendarYear()` and years elapsed.
  - `computeDefaultDistribution` returns a map keyed by calendar year with split values.
  - `formatMillions(22700000)` → `$22.7M`; `toAbsoluteDollarsFromMillions(22.7)` → `22700000`.

### [x] Step: Implement Contract Editor Drawer UI
<!-- chat-id: f084602f-ba5b-48a5-a2a1-fa2d119a1b83 -->
Task definition
- Create `docs/roster_cap_tool/js/ui/modals/contractEditor.js` that exports `openContractEditor(player)` rendering a side-drawer `<dialog>`.
- Drawer shows a table-like grid with a column per year, two inputs per column: Salary and Bonus (editable, millions).
- Include footer actions: Reset and Close.

Contracts to implement/use
- Editor API: `openContractEditor(player)`
- Use a11y helper: `enhanceDialog` from `docs/roster_cap_tool/js/ui/a11y.js`
- Test hooks/selectors:
  - Root: `[data-testid="contract-editor"]`
  - Year header: `[data-testid="ce-year"]` (text = 4-digit year)
  - Inputs: `[data-testid="ce-input-salary"][data-year="YYYY"]`, `[data-testid="ce-input-bonus"][data-year="YYYY"]`
  - Buttons: `[data-testid="ce-reset"]`, `[data-testid="ce-close"]`

Deliverable
- New module renders drawer with default values populated from `computeDefaultDistribution(player)` (or custom map from state when present).

Verification
- Temporarily call `openContractEditor(window.__anyPlayer)` from console to verify drawer renders, shows default columns and values.

### [x] Step: Wire Editor Inputs to In-Memory State (Auto-save)
<!-- chat-id: 90a47357-7452-4d57-ae56-58194faa46ba -->
Task definition
- On input `input`/`change`, parse values (millions) and save absolute dollars to `customContractsByPlayer` via `setCustomContract`.
- Re-open editor loads and displays custom values if present.
- Display formatted preview next to inputs using `formatMillions`.

Contracts to implement/use
- `getCustomContract`, `setCustomContract`, `resetCustomContract`
- `toAbsoluteDollarsFromMillions`, `formatMillions`

Deliverable
- Editing any Salary/Bonus cell updates the UI immediately and persists for the current session; re-opening reflects changes.

Verification
- Manually edit values; close the dialog; re-open for the same player and confirm the edited values are shown and formatted `$XM`.

### [x] Step: Add Reset Behavior
<!-- chat-id: bf71f1cc-1561-4f49-a5df-178cde64f089 -->
Task definition
- Implement Reset button to clear player’s custom map via `resetCustomContract(player.id)` and re-render defaults.

Contracts to implement/use
- `resetCustomContract(playerId)`
- `computeDefaultDistribution(player)`

Deliverable
- Clicking Reset restores default 50/50 values and clears in-memory custom values for that player.

Verification
- Edit one or more cells, click Reset, observe defaults restored; re-open editor and verify no custom values remain.

### [x] Step: Hook Player Table to Open Editor
<!-- chat-id: cc9439c5-b709-4db2-bda3-29b4536a9808 -->
Task definition
- In `docs/roster_cap_tool/js/ui/playerTable.js`, attach a click handler on the Active Roster table’s `.cell-player` to call `openContractEditor(p)`.
- Optionally add an action select item for “Contract Distribution” as a secondary entry point.

Contracts to implement/use
- Import `openContractEditor` from `./modals/contractEditor.js`.

Deliverable
- Clicking a player row (name cell) opens the Contract Distribution Editor for that player.

Verification
- Run the app and click a player in Active Roster; confirm the editor opens with correct year headers and values.

### [x] Step: Drawer and Grid Styles
<!-- chat-id: 6ed94e26-d24d-4e18-bf49-ec087ddac071 -->
Task definition
- Extend `docs/roster_cap_tool/css/styles.css` with styles for a right-side drawer look using `<dialog>`:
  - `.drawer` container, `.drawer--open`, grid for year columns, input adornments for “M” suffix.
- Reuse existing color variables and modal styling.

Contracts to implement/use
- No JS contracts; CSS classes referenced by `contractEditor.js` structure.

Deliverable
- Visual layout matches the side-drawer reference; inputs are clear and usable.

Verification
- Manual visual check; ensure mobile responsiveness doesn’t break layout; keyboard navigation works with `enhanceDialog`.

### [x] Step: E2E Test — Contract Editor
<!-- chat-id: 8dc2081e-c429-48bf-8f6d-e9a39d16233d -->
Task definition
- Add Playwright test `tests/e2e/contract_editor.spec.ts` to verify core flows end-to-end.

Contracts to implement/use
- Selectors as defined under the editor module test hooks.

Deliverable
- Test covers: open editor on click, default values, edit + persist on reopen, currency formatting, Reset restoring defaults.

Verification
- Run `npx playwright test` and confirm the new spec passes. Use the configured static server from `playwright.config.ts`.

### [x] Step: Update Usage Docs (Optional)
<!-- chat-id: 49d62c22-9c38-4718-87f3-32d084a72f08 -->
Task definition
- Update `docs/roster_cap_tool/USAGE.md` with a short subsection describing the Contract Distribution Editor and how values are interpreted (millions, 1-decimal display, in-memory only).

Contracts to implement/use
- None (documentation only).

Deliverable
- New doc section with a brief how-to and caveats.

Verification
- Rendered markdown reads clearly; links and file paths are correct.

### [x] Step: Get rid of years+1 and etc
<!-- chat-id: 41f5e0ae-6727-48a8-9cd5-e3df45ffc7fa -->

Currently we use Year+1 and etc, i want to replace it with actual years, 
Current year = 2026
year+1 = 2027
year+2 = 2028 and etc

Please get rid of Y0 year+1 Y+1 etc. 

Also update the FA year with corresponding year. FA=1 is 2026, FA=2 is 2027 and etc

Basicly create a simple dictionary, its must be just user representation change, all our logic can use Y+1 or whathewer, Just in interface base line year shuld be 2026 and shown as a 2026 not Year 1 in every place in UI, new added and old already exist representation

Completed:
- Replaced Y+N/Year 1 labels with actual calendar years using team.calendarYear (baseline 2026) across UI components:
  - Offer Modal: “Year 1 Cap Hit” → “2026/20XX Cap Hit” depending on context.
  - Trade In Modal: table header and confirm message updated to 20XX.
  - Conversion Modal: future year chips now show 20XX instead of “Year +N”.
  - Projections: badge text now “Applied to 20XX …”.
  - Draft Picks: headers/footers now “20XX” instead of “Year 1”.
  - Placeholder table header updated from 2025 → 2026.
- FA Year column already renders absolute year via calendarYear + yearsLeft.
