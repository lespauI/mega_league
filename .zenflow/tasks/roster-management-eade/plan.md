# New feature


## Configuration
- **Artifacts Path**: `.zenflow/tasks/{task_id}`
the actual path should be substituted for {@artifacts_path}

---

## Workflow Steps

### [x] Step: Requirements
<!-- chat-id: b01c9885-8b2a-4b9f-90ef-8425fe822330 -->

Your job is to generate a Product Requirements Document based on the feature description,

First, analyze the provided feature definition and determine unclear aspects.  For unclear aspects:
       - Make informed guesses based on context and industry standards
       - Only mark with [NEEDS CLARIFICATION: specific question] if:
         - The choice significantly impacts feature scope or user experience
         - Multiple reasonable interpretations exist with different implications
         - No reasonable default exists
      - Prioritize clarifications by impact: scope > security/privacy > user experience > technical details

Ask up to 5 most priority clarifications to the user. Then, create the document following this template:

```
# Feature Specification: [FEATURE NAME]


## User Stories*


### User Story 1 - [Brief Title]

**Acceptance Scenarios**:

1. **Given** [initial state], **When** [action], **Then** [expected outcome]
2. **Given** [initial state], **When** [action], **Then** [expected outcome]

---

## Requirements*

## Success Criteria*

```

Save the PRD into `{@artifacts_path}/requirements.md`.

Status: Completed. See `.zenflow/tasks/roster-management-eade/requirements.md`.

### [x] Step: Technical Specification
<!-- chat-id: df991ac4-d4f7-48af-aa97-dfd48302df78 -->

Based on the PRD in `{@artifacts_path}/requirements.md`, create a detailed technical specification to be used by a coding agent to implement the feature. Follow this template:

```
# Technical Specification: [FEATURE]

## Technical Context
Language/Version, primary dependencies, etc

## Technical Implementation Brief

Summarize key technical decisions for implementing the feature. Make sure they take into account the existing code as much as possible.

## Source Code Structure

## Contracts

Define addition or changes in data models, DB schemas, APIs, code interfaces etc

## Delivery Phases

Define several incremental deliverables for the feature. Each should be a minimal viable product testable end-to-end.

## Verification Strategy 

Define how the coding agent can verify each deliverable it creates. Provide instructions for the agent to perform the verification using available tools (lint/test commands, bash commands) and create helper scripts and tools for more complex result verification.
The verification for each deliverable should be executable by a coding agent using built-in capabilities (lint and test commands from the project, bash commands), pre-generated helper scripts or MCP servers. Research and add to the spec:

- MCP servers that should be installed to help the agent with the verification 

- helper scripts that need to be generated in the first phases of the plan to verify complex scenarios that can't be covered by the tests in the project's test framework(s)

- any sample input artifact(s) that are required for verification. Note if these artifacts can be a) generated by the agent; b) discovered by the agent on line; c) must be provided by the user.
```

Save the spec to `{@artifacts_path}/spec.md`.

Status: Completed. See `.zenflow/tasks/roster-management-eade/spec.md`.

### [x] Step: Implementation Plan
<!-- chat-id: 9ef309d5-3d2a-4e50-8e76-ac34563749e8 -->

Based on the technical spec in `{@artifacts_path}/spec.md`, create a detailed task plan and update `{@artifacts_path}/plan.md`. Each task should have task definition, references to contracts to be used/implemented, deliverable definition and verification instructions.

Format each task as 
```
### [ ] Step: <task_name>
Task instructions
```

"Step:" prefix is important, do not omit it!

Status: Completed. Detailed implementation plan added below.

### [x] Step: Project Scaffolding (Pure JS)
Task instructions
- Definition: Create a static app under `docs/roster_cap_tool/` with `index.html`, `css/styles.css`, and ES module files in `js/`. No bundler, no transpiler, no Node runtime required. Use standards-based web components/DOM manipulation.
- Contracts: Source layout now: `docs/roster_cap_tool/{index.html, css/, js/}`. No React/TS/Zustand.
- Deliverable: Loadable page from file:// and GitHub Pages; app bootstraps with placeholder panels.
- Verification: Open `docs/roster_cap_tool/index.html` locally or serve via `python3 -m http.server` and visit `http://localhost:8000/docs/roster_cap_tool/`.

### [x] Step: Data Models (JS) & Validation
Task instructions
- Definition: Define JS JSDoc typedefs in `js/models.js` for `Team`, `Player`, `CapSnapshot`, `ScenarioMove`. Implement small validation/coercion helpers (number/boolean parsing) in `js/validation.js`.
- Contracts: Mirrors “Contracts > Data models”; replace Zod with lightweight manual validators.
- Deliverable: Exported typedefs and validators used across the app.
- Verification: Add a browser test page `docs/roster_cap_tool/test.html` that runs validation against sample rows and logs pass/fail to console.

### [x] Step: CSV Loader & Normalization
Task instructions
- Definition: Implement `js/csv.js` using PapaParse (CDN) to fetch and parse CSVs; normalize rows with `validation.js`; expose `loadTeams()` and `loadPlayers()` returning arrays.
- Contracts: Input files are served statically; normalization mirrors schema fields in PRD/spec.
- Deliverable: Data loads from `./data/MEGA_players.csv` and `./data/MEGA_teams.csv`; warning panel gets invalid row counts.
- Verification: Open `test.html` to execute loader smoke; or use browser devtools on `index.html` to view loaded counts and sample rows.

### [x] Step: Data Placement for GitHub Pages
Task instructions
- Definition: Copy CSVs into `docs/roster_cap_tool/data/` so GitHub Pages can serve them (Pages does not serve repo root). Add a small sync script `scripts/sync_data_to_docs.sh` to copy updated CSVs when needed.
- Contracts: Uses repo-root `MEGA_players.csv`, `MEGA_teams.csv` as source of truth.
- Deliverable: `docs/roster_cap_tool/data/MEGA_players.csv` and `docs/roster_cap_tool/data/MEGA_teams.csv` checked in.
- Verification: Access `docs/roster_cap_tool/data/MEGA_players.csv` in browser; CSV downloads successfully.

### [x] Step: Cap Math Library (Pure Functions)
<!-- chat-id: b67a3193-570c-43b2-a9b6-8084fd64ad8d -->
Task instructions
- Definition: Implement `js/capMath.js` with pure functions: `calcCapSummary`, `simulateRelease`, `simulateTradeQuick`, `simulateExtension`, `simulateConversion`, `simulateSigning` per spec and Madden rules (bonus proration max 5 years).
- Contracts: Formulas and examples from `spec/Salary Cap Works in Madden.md`.
- Deliverable: Functions exported via ES modules; used by UI and verification scripts.
- Verification: Add cases to `test.html` to run these functions and assert outputs; also cross-check via `scripts/verify_cap_math.py`.

### [x] Step: App State (Pub/Sub Store)
<!-- chat-id: 7833658b-714c-4997-817a-123985ac5db5 -->
Task instructions
- Definition: Implement `js/state.js` as a simple pub/sub store holding selected team, players, free agents, dead money ledger, and move history. Provide derived getters for cap summary and filtered lists.
- Contracts: Same selectors concept from spec but implemented as functions: `getCapSummary()`, `getActiveRoster()`, `getFreeAgents()`.
- Deliverable: Store initializes after CSV load; notifies listeners to re-render.
- Verification: Log state transitions in devtools; `test.html` can exercise selectors.

### [x] Step: Team Selector & Cap Summary Panel
<!-- chat-id: 77f1c5e4-7c52-4b76-90f1-654124cdf0de -->
Task instructions
- Definition: Implement `js/ui/teamSelector.js` and `js/ui/capSummary.js`; sticky header with progress bar; shows original/current cap, cap spent, cap space, and delta; updates on store changes.
- Contracts: Uses store getters and `calcCapSummary`.
- Deliverable: Interactive header that updates as actions occur.
- Verification: Manual check in browser; console asserts for value changes when switching teams.

### [x] Step: Roster Tabs & Tables (Active + Free Agents)
<!-- chat-id: 3744afdd-1460-45db-8617-06258c1d98f7 -->
Task instructions
- Definition: Implement `js/ui/rosterTabs.js` and `js/ui/playerTable.js`; Active Roster and Free Agents tabs with specified columns; sortable by cap hit; action column with dropdown.
- Contracts: Columns and filters per PRD; uses `getActiveRoster()` and `getFreeAgents()`.
- Deliverable: Two functional tables with sorting and row numbering.
- Verification: Manual sort checks; console logs for selected actions.

### [x] Step: Release Flow (Action + Modal)
<!-- chat-id: 19dc21bd-8878-4b86-92bd-bbde00603e6e -->
Task instructions
- Definition: Add Action dropdown with “Release”; implement a modal using `<dialog>` in `js/ui/modals/releaseModal.js` showing Dead Cap Hit, Cap Savings, and New Cap Space; on confirm apply move and update store.
- Contracts: `simulateRelease`, `ScenarioMove` (ReleaseMove); fields `capReleasePenalty`, `capReleaseNetSavings`.
- Deliverable: Releasing a player updates roster and Cap Summary in real time.
- Verification: Manual modal preview; console assert of cap increase equals previewed savings.

### [x] Step: Free Agent Signing Flow (Offer Modal)
<!-- chat-id: 256cba22-b39c-4559-b886-66e6558dffad -->
Task instructions
- Definition: Add “Make Offer” for FAs; implement `js/ui/modals/offerModal.js` with years/salary/bonus inputs and cap preview; block signing if `capAvailable < year1CapHit`; on confirm, sign player and mark `isFreeAgent = false`.
- Contracts: `simulateSigning`; warning if offer < 90% of desired terms.
- Deliverable: Signing updates Active Roster and Cap Summary; warning shown when low offer.
- Verification: Manual offer at desired values shows expected Year 1 Cap Hit and reduces cap accordingly.

### [x] Step: Dead Money & IR Tabs + Trade Quick
<!-- chat-id: 2e5cc953-d333-4bb9-a65f-4b348d1f44d6 -->
Task instructions
- Definition: Implement “Dead Money” tab listing penalties accumulated; minimal IR tab filtered by available injury surrogate; add “Trade → Quick Simulate” that removes player and applies `capReleasePenalty`.
- Contracts: `simulateTradeQuick`; store dead money ledger; table filters.
- Deliverable: Trade quick updates Dead Money tab and Cap Summary; IR tab present.
- Verification: Manual quick trade; ensure dead money row appears and summary matches.

### [x] Step: Extension Flow
<!-- chat-id: 7f3aef75-d5a3-4da2-be40-c1ad9b28218c -->
Task instructions
- Definition: Add “Extension” action for players with `contractYearsLeft ≤ 2`; implement modal `js/ui/modals/extensionModal.js` with years slider (1–7), salary and bonus inputs; preview new cap hit `(salary + bonus)/years`; apply on confirm.
- Contracts: `simulateExtension`.
- Deliverable: Before/after cap comparison in modal; applying updates Cap Summary.
- Verification: Manual preview delta equals applied delta.

### [x] Step: Conversion Flow
<!-- chat-id: 245cad15-2389-4254-a174-01a6d8f6a679 -->
Task instructions
- Definition: Add “Conversion” action for high `capHit` players; implement modal `js/ui/modals/conversionModal.js` to convert base salary to signing bonus with proration and show multi-year impact.
- Contracts: `simulateConversion`; proration max 5 years.
- Deliverable: Modal displays current vs future cap hits; applying updates current year snapshot.
- Verification: Manual compare preview vs applied change.

### [x] Step: Projections View (3–5 Years)
<!-- chat-id: a4f7e2c5-7824-40ee-9f99-9954519ad559 -->
Task instructions
- Definition: Implement projections panel `js/ui/projections.js` showing next 3–5 seasons impacts based on `contractYearsLeft` and dead money rules.
- Contracts: Extend `capMath` with projection helpers; use store roster state.
- Deliverable: Read-only projections view for selected team.
- Verification: Manual spot-checks with known examples.

### [x] Step: Scenario Save/Load (What-if Mode)
<!-- chat-id: ec84ec4c-bb5d-4041-b1ce-c63b2958e810 -->
Task instructions
- Definition: Add scenario model and localStorage persistence; allow save, load, and compare scenarios.
- Contracts: `Scenario` shape defined in `models.js`.
- Deliverable: Scenario controls with save/load and baseline/active comparison.
- Verification: Manual save/load; inspect localStorage entries.

### [x] Step: Browser Test Page (Smoke)
<!-- chat-id: 1041fc8d-a4e1-40f7-9516-8882c0d454a9 -->
Task instructions
- Definition: Create `docs/roster_cap_tool/test.html` that programmatically simulates: load team → release a player → sign a FA; logs assertions to console for cap deltas.
- Contracts: Uses exported functions and store actions.
- Deliverable: One-click browser smoke test without Node tooling.
- Verification: Open `test.html` and check console output for PASS lines.

### [x] Step: Helper Verification Scripts & Fixtures
<!-- chat-id: 4d1055c7-33ea-4d07-9bf2-cce74451181f -->
Task instructions
- Definition: Implement `scripts/verify_cap_math.py`, `scripts/smoke_roster_cap_tool.sh`, and `scripts/fixtures/cap_scenarios.json`. Generate `output/tiny_teams.csv` if missing for tiny tests.
- Contracts: Script I/O per spec; relies on same formulas as `capMath`.
- Deliverable: Scripts produce `output/cap_tool_verification.json` and smoke-check that `docs/roster_cap_tool/` contains required assets and serves via local http.server.
- Verification: `python3 scripts/verify_cap_math.py`; `bash scripts/smoke_roster_cap_tool.sh`.

### [x] Step: Styling, Accessibility, Responsive
<!-- chat-id: 3a3ba701-4138-4fce-a783-b18c9db6f0a9 -->
Task instructions
- Definition: Apply Spotrac-inspired colors (green/red/yellow/blue) via plain CSS; responsive grid/tables; accessible `<dialog>` modals with focus trapping.
- Contracts: None; aligns with PRD “UI/UX Requirements”.
- Deliverable: Polished UI with sticky Cap Summary, color coding, responsive layout.
- Verification: Manual checks on desktop/tablet/mobile widths.

### [x] Step: Documentation & References (GitHub Pages)
<!-- chat-id: a3f942ee-3336-493e-99c1-225070361e52 -->
Task instructions
- Definition: Update `README.md` and add `docs/roster_cap_tool/USAGE.md` documenting pure JS architecture, data folder, how to enable GitHub Pages (serve `/docs`), and verification steps; link to `spec/Salary Cap Works in Madden.md`.
- Contracts: Reference PRD/spec paths.
- Deliverable: Clear docs for running and verifying the tool from GitHub Pages.
- Verification: Links and instructions validated locally; Pages loads post-publish.

### [x] Step: Fix bug
<!-- chat-id: 02298e49-e1af-4000-825c-83ad522c7258 -->

I open roster and see its empty, same time free agents are in place, fix this bug

Implementation notes:
- Root cause: `players.team` in `MEGA_players.csv` uses full team names (e.g., "Bengals"), while `selectedTeam` uses `teams.abbrName` (e.g., "CIN"). Active roster filter compared `p.team === selectedTeam`, yielding no matches.
- Fix: In `initState` normalize `player.team` to the team's `abbrName` using a mapping of `abbrName`/`displayName`/`teamName` → `abbrName`. Free agents remain unchanged.
- File changed: `docs/roster_cap_tool/js/state.js`.
- Verification: Load app and select any team. Active Roster lists players; Free Agents unchanged; actions work as before.

### [x] Step: add ability to setup draft pics
<!-- chat-id: ab4b0875-aa69-4113-b24f-1422282be294 -->

We don't have data on draft picks; let's set the ability to set up draft picks and calculate the approximate rookie reserve required.

Implementation notes:
- Added rookie reserve estimation math in `docs/roster_cap_tool/js/capMath.js`:
  - `estimateRookieYear1ForSlot(round, pickInRound)` and `estimateRookieReserveForPicks({1..7})` with a round-based linear scale.
- Extended app state in `docs/roster_cap_tool/js/state.js`:
  - Persist per-team draft picks under `localStorage` key `rosterCap.draftPicks`.
  - New getters/setters: `getDraftPicksForSelectedTeam()`, `setDraftPicksForSelectedTeam()`, `getRookieReserveEstimate()`.
  - `getCapSummary()` now includes `rookieReserveEstimate` and `capAfterRookies`.
- New UI tab renderer `docs/roster_cap_tool/js/ui/draftPicks.js`:
  - Per-round pick count inputs, estimated per-pick Year 1, per-round totals, and grand total.
  - Reset/default buttons; advisory note.
- Updated mounts:
  - `main.js` mounts `mountDraftPicks()` on load and on state changes.
  - `capSummary` now displays Rookie Reserve and Cap After Rookies.

Verification:
- Open `docs/roster_cap_tool/index.html` → Draft Picks tab:
  - Change counts; Rookie Reserve total updates and persists per team.
  - Cap Summary shows Rookie Reserve and Cap After Rookies reflecting the estimate.

### [x] Step: Reset button whipe roster
<!-- chat-id: 9d2fca8a-0f31-4716-b41a-98f16ea2d937 -->

Bug: Hitting Reset cleared the visible roster. Root cause was `baselinePlayers` stored from raw CSV (full team names), while current filters rely on normalized team `abbrName`. Reset replaced normalized players with raw baseline, causing Active Roster filter to match zero rows.

Fix implemented:
- In `docs/roster_cap_tool/js/state.js`, set `baselinePlayers` to a deep copy of the normalized `state.players` (not the raw `players` array). This ensures Reset restores the true default roster.

Verification:
- Load app, switch team, perform a release/sign. Press Reset. Active Roster returns to original list; Free Agents and cap summary revert to baseline. Draft picks remain unchanged.

### [x] Step: Visual bug in roster
<!-- chat-id: ee04d146-5b6f-4ca6-9469-7dcab0da45e3 -->

Fix: Table header appeared below the first player row due to an incorrect sticky offset in CSS (`th { top: calc(58px + 44px) }`). Since the table scrolls inside `.table-container` (overflow: auto), the header should stick at the top of that container, not offset for the page header/tabs.

Changes:
- Updated `docs/roster_cap_tool/css/styles.css` to set `th { position: sticky; top: 0; z-index: 2; }` and removed the larger offsets in the responsive section.

Verification:
- Open Active Roster: header now renders as the first row and remains correctly sticky within the table container while scrolling.

### [x] Step: Make all table columns sortable
<!-- chat-id: 5fdd1b9c-3ae7-4d1a-8f22-a4b8b1e0c0e7 -->

Add full-table sorting across all headers for Active Roster and Free Agents.

Changes:
- Updated `docs/roster_cap_tool/js/ui/playerTable.js` to:
  - Define header metadata with keys for every column.
  - Add click handlers to all headers to toggle sort direction.
  - Implement robust sort value mapping for each key (player name, cap hit, dead money, contract value, FA year, etc.).
  - Keep Action column sortable (groups by extension eligibility for Active; stable for FAs).

Verification:
- Click any header in Active Roster or Free Agents; rows re-sort accordingly; clicking again toggles sort direction.

### [x] Step: In projection the Roster cap for DAL
<!-- chat-id: 9467ffe8-6ca1-467f-b1f8-3f8bbfc6053e -->

Issue: DAL showed Roster Cap $321,560,000 and Cap Space -$17M in Projections (Year 1). Root cause: Year 1 used a straight sum of all non-FA DAL players’ `capHit` (66 players = $321.56M) and compared it to `capRoom` ($304.2M), ignoring the in‑game baseline totals (`capSpent`/`capAvailable`). That mismatch produced an impossible negative space mid‑season.

Fix implemented:
- Anchored Year 1 (current season) in `projectTeamCaps()` to team snapshot:
  - `totalSpent₀ = team.capSpent + deltaFromMoves`
  - `capSpace₀ = team.capAvailable − deltaFromMoves`
  - `deadMoney₀` reflects only new scenario moves; `rosterCap₀ = max(0, totalSpent₀ − deadMoney₀)`
- Left future years (Year 2+) as roster‑sum projections with conversion and dead‑money schedules.
- Added a UI note in Projections: “Year 1 is anchored to the in‑game snapshot (capSpent/capAvailable). Roster Cap is derived; Dead Money reflects only scenario moves.”

Files changed:
- `docs/roster_cap_tool/js/capMath.js` (Year 1 anchoring logic in `projectTeamCaps`)
- `docs/roster_cap_tool/js/ui/projections.js` (explanatory note)

Verification:
- DAL totals now show `Cap Space` equal to the in‑game `capAvailable` for Year 1 and never negative; applying a release/sign adjusts by the move deltas. Future years remain projection‑based.

### [ ] Step: Dead money

Dead money shoult be split to 2 years and we need to show it in dead money page. Also if we dont have current team dead money info, lets allow user to set it manualy

### [ ] Step: Add posobility to trade for the player

We have free agent sign but lets also add Trade IN button, to add player contract from any other roster, lets add search by player name. Remember when we trade for player we add only his salary, bonus is dead mone fro another team
