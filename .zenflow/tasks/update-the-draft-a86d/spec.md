# Technical Specification: Draft Analysis Enhancements — Round 1 Recap and Section Intro Text Blocks

## Technical Context
- Language: Python 3.9+ (align with existing scripts in `scripts/`)
- Runtime: CLI scripts invoked via `python3`
- Primary dependencies: Standard library only (csv, argparse, os, sys, statistics, html, re). Avoid external packages to match current repo patterns (see `scripts/verify_draft_class_analytics.py`).
- Data inputs:
  - `MEGA_players.csv` (players with ratings/traits, rookie year, draft info)
  - `MEGA_teams.csv` (team metadata, `logoId` mapping)
- Outputs: Single self-contained HTML file generated by `scripts/generate_draft_class_analytics.py` under `docs/` (e.g., `docs/draft_class_2026.html`).
- Existing artifacts: `scripts/generate_draft_class_analytics.py` renders sections: KPIs, Elites Spotlight, Team Draft Quality — by Avg OVR, Elites-only tables, Round hit/miss tables. `scripts/verify_draft_class_analytics.py` validates core sections. `scripts/smoke/smoke_generate_draft_2026.sh` performs a smoke run.

## Technical Implementation Brief
- Extend `scripts/generate_draft_class_analytics.py` to:
  1) Append a new “Round 1 Recap” section at the end of the page that lists every first-round pick (1–32) with: team logo, team name, player name, position, grade badge, key Madden attributes (position-specific), trait badges, and player photo (if `portraitId` is available).
  2) Add an optional multi-line intro text block at the top of key sections (KPIs, Elites Spotlight, Team Draft Quality — by Avg OVR, Positions) with safe wrapping. Provide a default placeholder when not supplied.

- Input contracts:
  - Read `portraitId` from `MEGA_players.csv` when present; photo URL is `https://ratings-images-prod.pulse.ea.com/madden-nfl-26/portraits/{portraitId}.png`.
  - Read `draftRound` and `draftPick` to identify Round 1 picks and display in ascending pick order.
  - Map attributes/traits to show per position using a code-embedded mapping (see Contracts) with graceful missing-data handling (skip absent keys).
  - Accept optional `--section-intros <file.json>` CLI argument with a mapping of section IDs to free-form intro text; default strings used when missing. Use `white-space: pre-wrap` for multi-line rendering.

- Non-breaking changes: Maintain all existing behavior and markup; only append a new nav anchor + section and render intro text blocks at the top of designated sections.

## Source Code Structure
- `scripts/generate_draft_class_analytics.py`
  - Add helpers:
    - `read_section_intros(path: str|None) -> dict`
    - `get_attr_keys_for_pos(pos: str) -> list[str]`
    - `get_trait_keys_for_pos(pos: str) -> list[str]`
    - `build_round1_entries(players_rows: list[dict], team_logo_map: dict) -> list[dict]`
    - `render_round1_recap(entries: list[dict]) -> str`
  - Extend `gather_rookies` to include optional fields used by recap: `portraitId`, and retain `draft_round`, `draft_pick`.
  - Inject section intro blocks into HTML template for: KPIs (`#kpis`), Elites Spotlight, Team Draft Quality — by Avg OVR, Positions; and add a new section `#round1` at the end.
  - Add CSS classes: `.section-intro { white-space: pre-wrap; color: #334155; font-size: 13px; margin: 8px 0 12px; }` and card layout for Round 1 recap entries.
- `scripts/verify_draft_round1_recap.py` (new): HTML validator for Round 1 Recap and section intro blocks.
- `scripts/smoke/smoke_generate_draft_2026.sh` (update or add a parallel script) to include new verification step.

## Contracts
- CLI: `scripts/generate_draft_class_analytics.py`
  - New optional flags:
    - `--section-intros <path>`: Path to a JSON file with intro text mapping.
    - `--intro-default <str>`: Fallback text when a section key is absent in the mapping (default: `Analysis: Add your insights about this section here.`).
  - No breaking changes to existing flags.

- Section intros JSON schema (example):
  ```json
  {
    "kpis": "Overall class looks balanced...",
    "elites": "Elite talent concentration...",
    "team_quality": "Average OVR by team shows...",
    "positions": "Position strength overview...",
    "round1": "Headline recap for Round 1..."
  }
  ```
  - Keys recognized: `kpis`, `elites`, `team_quality`, `positions`, `round1` (others are ignored). All values are strings; multi-line supported.

- Data model additions (in-memory only):
  - In `gather_rookies` result dict, add keys when present:
    - `portrait_id`: from players row `portraitId` (string)
    - `draft_round`: already present (int|None)
    - `draft_pick`: already present (int|None)

- Position attribute mapping (display up to 8–10 per player; prioritize in order listed):
  - QB: `throwAccShort`, `throwAccMid`, `throwAccDeep`, `throwPower`, `throwUnderPressure`, `throwOnRun`, `playAction`, `awareRating`, `speedRating`, `breakSackRating`
  - HB/RB: `speedRating`, `accelRating`, `agilityRating`, `breakTackleRating`, `truckRating`, `jukeMoveRating`, `spinMoveRating`, `stiffArmRating`, `carryRating`, `catchRating`, `bCVRating`
  - FB: `runBlockRating`, `leadBlockRating`, `impactBlockRating`, `strengthRating`, `truckRating`, `catchRating`
  - WR: `catchRating`, `specCatchRating`, `cITRating`, `speedRating`, `routeRunShort`, `routeRunMed`, `routeRunDeep`, `releaseRating`, `agilityRating`, `changeOfDirectionRating`
  - TE: `catchRating`, `cITRating`, `runBlockRating`, `passBlockRating`, `speedRating`, `routeRunShort`, `routeRunMed`, `strengthRating`, `specCatchRating`
  - OL (T/G/C): `passBlockRating`, `passBlockPower`, `passBlockFinesse`, `runBlockRating`, `runBlockPower`, `runBlockFinesse`, `strengthRating`, `awareRating`, `impactBlockRating`
  - DE: `powerMovesRating`, `finesseMovesRating`, `blockShedRating`, `pursuitRating`, `tackleRating`, `strengthRating`, `speedRating`, `hitPowerRating`
  - DT: `powerMovesRating`, `blockShedRating`, `strengthRating`, `tackleRating`, `pursuitRating`, `hitPowerRating`
  - LB: `tackleRating`, `pursuitRating`, `hitPowerRating`, `blockShedRating`, `playRecRating`, `zoneCoverRating`, `manCoverRating`, `speedRating`, `awareRating`
  - CB: `manCoverRating`, `zoneCoverRating`, `speedRating`, `accelRating`, `agilityRating`, `pressRating`, `playRecRating`, `catchRating`, `changeOfDirectionRating`
  - S (FS/SS): `zoneCoverRating`, `tackleRating`, `hitPowerRating`, `speedRating`, `playRecRating`, `pursuitRating`, `manCoverRating`, `awareRating`, `catchRating`
  - K/P: `kickPowerRating`, `kickAccRating`

- Trait badges (present → show; enum → show value):
  - QB: `clutchTrait`, `sensePressureTrait`, `throwAwayTrait`, `tightSpiralTrait`, `forcePassTrait`
  - Ball carriers: `coverBallTrait`, `fightForYardsTrait`, `runStyle`
  - Receivers: `feetInBoundsTrait`, `specCatchTrait`, `posCatchTrait`, `yACCatchTrait`, `dropOpenPassTrait`
  - Defenders: `bigHitTrait`, `stripBallTrait`, `playBallTrait`
  - DL: `dLBullRushTrait`, `dLSpinTrait`, `dLSwimTrait`

- Grade calculation (with override):
  - Default algorithm if no author-provided input: derive a letter grade based on OVR and dev tier relative to class averages.
    - Compute z-score of player OVR vs class OVR mean/std; adjust ±0.5 grade steps for dev tier (XF:+0.5, SS:+0.25, Star:+0.1, Normal:+0).
    - Map score to letter: `>=1.25:A`, `>=0.5:A-`, `>=0.0:B+`, `>=-0.5:B`, `>=-1.0:B-`, else `C+`.
    - If stddev < 1.0 or OVR missing: default to `B` and rationale “Insufficient inputs; default applied.”
  - Future-proof: allow optional `gradeOverride` field per player via an external JSON mapping keyed by player id or name (not required for this delivery).

## Delivery Phases
1) Minimal HTML intros
   - Add `--section-intros` and `--intro-default` support.
   - Render `.section-intro` blocks at the top of KPIs, Elites Spotlight, Team Draft Quality, Positions.
   - Default text: `Analysis: Add your insights about this section here.`

2) Round 1 Recap data plumbing
   - Include `portrait_id` in `gather_rookies` (from `portraitId`).
   - Build Round 1 player list by filtering `draft_round == 1` and sorting by `draft_pick` asc; fallback to name when pick missing.
   - Compute grades for each pick as per algorithm; attach team logo via `team_logo_map`.

3) Round 1 Recap UI and rendering
   - Add `#round1` section and nav anchor.
   - Card layout per pick: left column photo (if available), right column with player/team/pos line, grade badge, key attributes table (2-column), and trait badges row.
   - Omit missing values gracefully; add `alt` text for images.

4) Verification tools
   - Add `scripts/verify_draft_round1_recap.py` to validate that:
     - `#round1` exists; contains 32 entries when data provides them.
     - Entries ordered by pick asc; each entry includes team, player, pos, and grade badge.
     - Photo URLs follow expected pattern when `portraitId` exists.
     - Section intros exist for KPIs, Elites Spotlight, Team Draft Quality, Positions.
   - Update `scripts/smoke/smoke_generate_draft_2026.sh` (or add `scripts/smoke/smoke_generate_draft_2026_round1.sh`) to run both verifiers.

## Verification Strategy
- Lint/style: Not applicable (no linter configured). Keep style consistent with existing scripts.
- Build/test commands:
  - Generate HTML for 2026: `python3 scripts/generate_draft_class_analytics.py --year 2026 --players MEGA_players.csv --teams MEGA_teams.csv --out docs/draft_class_2026.html`
  - With intros: `python3 scripts/generate_draft_class_analytics.py --year 2026 --section-intros scripts/fixtures/section_intros_example.json --out docs/draft_class_2026.html`

- Helper verification scripts to implement:
  - `scripts/verify_draft_round1_recap.py` (stdlib only):
    - Inputs: `YEAR`, `--players`, `--teams`, `--html`.
    - Process:
      - Parse HTML as text; locate `id="round1"`, count entries via predictable class names (e.g., `.r1-card`).
      - Validate ordering and presence of fields via regex or minimal HTML parsing.
      - Confirm image URLs for entries where players have a non-empty `portraitId` in CSV: pattern match against `https://ratings-images-prod.pulse.ea.com/madden-nfl-26/portraits/\d+\.png`.
      - Confirm `.section-intro` blocks exist in KPIs, Elites Spotlight, Team Draft Quality, Positions.
    - Exit non-zero on failure; print concise diagnostics.

- Smoke script:
- Extend existing `scripts/smoke/smoke_generate_draft_2026.sh` to invoke the new verifier, e.g.:
    ```bash
    python3 scripts/verify_draft_round1_recap.py 2026 \
      --players MEGA_players.csv \
      --teams MEGA_teams.csv \
      --html docs/draft_class_2026.html
    ```

- MCP servers recommended for agent verification:
  - filesystem (fs) MCP: browse/read/write repository files for spec conformance checks.
  - shell MCP: run generation and verification scripts deterministically.
  - optional http MCP (or curl via shell): HEAD/GET checks for a small sample of portrait URLs to ensure 200/OK; treat network as best-effort and do not fail the build on transient network errors.

- Sample input artifacts:
  - Players/Teams CSVs: `MEGA_players.csv`, `MEGA_teams.csv` (present in repo) — discovered locally by the agent.
  - Section intros example JSON (to add under `scripts/fixtures/section_intros_example.json`):
    ```json
    {
      "kpis": "Class KPIs indicate balanced dev tiers with strong top-end talent.",
      "elites": "Elites Spotlight: XF/SS concentration in top positions.",
      "team_quality": "Avg OVR by team highlights organizations hitting above league mean.",
      "positions": "Positional depth: early signs of WR/CB strength; OL steady.",
      "round1": "Round 1 delivered immediate-impact players and a few value steals."
    }
    ```
  - These example artifacts can be generated by the agent.

Notes and edge cases:
- If fewer than 32 Round 1 players exist in the CSV, render as many as present and display a muted note `Showing N of 32 picks`.
- If a player is missing attributes or traits, omit silently; never crash.
- If `portraitId` missing/invalid, omit image container for that card to avoid broken icons.
