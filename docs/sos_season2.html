<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Season 2 Strength of Schedule — Table + Bars + Opponents</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root {
      --bg: #f7f7f7;
      --card: #fff;
      --border: #e5e5e5;
      --muted: #666;
      --muted2: #999;
      --text: #1a1a1a;
      --accent: #0ea5e9;
      --hover: #fafafa;
      --axis: #9aa0a6;
      --grid: #efefef;
      --red: #ef4444;
      --blue: #0ea5e9;
    }
    body { margin: 16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--text); background: var(--bg); }
    .container { max-width: 1200px; margin: 0 auto; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px 18px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .subtitle { color: var(--muted); font-size: 13px; margin: 2px 0 10px; }
    /* Tabs */
    .tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
    .tab { padding: 8px 12px; border: 1px solid var(--border); border-bottom: none; border-radius: 8px 8px 0 0; background: #f5f7fa; cursor: pointer; font-weight: 600; color: #333; }
    .tab.active { background: var(--card); color: #000; }
    .view { display: none; }
    .view.active { display: block; }
    /* Shared controls */
    .controls { display: flex; gap: 10px; align-items: center; margin: 8px 0 12px; flex-wrap: wrap; }
    .controls label { font-size: 13px; color: var(--muted); margin-right: 4px; }
    select { padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; }
    /* Table styles */
    .table-wrap { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: #fff; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { background: #fafafa; color: #555; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; font-size: 11px; padding: 9px 8px; text-align: left; border-bottom: 2px solid var(--border); user-select: none; cursor: pointer; }
    thead th.num { text-align: right; }
    tbody td { padding: 10px 8px; border-bottom: 1px solid #f1f1f1; }
    tbody tr:hover { background: var(--hover); }
    .team-cell { display: flex; align-items: center; gap: 8px; font-weight: 600; }
    .logo { width: 26px; height: 26px; object-fit: contain; }
    .muted { color: var(--muted2); font-size: 12px; }
    .sort-ind { color: var(--accent); margin-left: 4px; font-size: 11px; }
    /* Bars styles */
    .panel { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: #fff; }
    .panel > .header { padding: 10px 14px; background: #f5f7fa; border-bottom: 1px solid #ebeff5; font-weight: 700; }
    .chart-wrap { padding: 8px; }
    .tooltip { position: absolute; pointer-events: none; background: rgba(0,0,0,.78); color: #fff; padding: 6px 8px; border-radius: 6px; font-size: 12px; z-index: 10; }
    .legend { display: flex; align-items: center; gap: 16px; color: #555; font-size: 12px; padding: 6px 10px 10px; }
    .swatch { display: inline-block; width: 12px; height: 12px; border-radius: 2px; margin-right: 6px; vertical-align: middle; }
    .avgLineLabel { fill: #555; font-size: 11px; }

    /* Opponents table */
    .opp-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 6px; border-radius: 16px; font-size: 12px; margin: 3px 4px; color: #111; border: 1px solid rgba(0,0,0,.08); background: #f3f4f6; }
    .opp-badge .opp-logo { width: 16px; height: 16px; object-fit: contain; border-radius: 2px; }
    .opp-elo { font-weight: 700; font-variant-numeric: tabular-nums; }
    .opp-row { display: flex; flex-wrap: wrap; }
    .opp-legend { display: flex; gap: 12px; align-items: center; font-size: 12px; color: #555; padding: 8px 0; }
    .opp-swatch { width: 14px; height: 14px; border-radius: 3px; display: inline-block; border: 1px solid rgba(0,0,0,.12); margin-right: 6px; }
  </style>
  <!-- Serve from repo root: python3 -m http.server 8000 -->
  <script>
    // Shared helpers
    async function tryCsv(paths) {
      let lastErr;
      for (const p of paths) {
        try { return await d3.csv(p, d3.autoType); } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Unable to load CSV: ' + paths.join(', '));
    }
    async function tryJson(paths) {
      let lastErr;
      for (const p of paths) {
        try { return await d3.json(p); } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Unable to load JSON: ' + paths.join(', '));
    }
    async function tryText(paths) {
      let lastErr;
      for (const p of paths) {
        try { return await d3.text(p); } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Unable to load TEXT: ' + paths.join(', '));
    }
    function fmt3(x) { return d3.format('.3f')(x); }
    function fmt1(x) { return d3.format('.1f')(x); }

    // 6-level color mapping for opponent ELO (original bins)
    function colorForElo(elo) {
      if (elo == null || isNaN(elo)) return '#e5e7eb';
      if (elo >= 1101.0 && elo <= 1133.5) return '#00AA00'; // Dark Green
      if (elo >= 1133.6 && elo <= 1166.2) return '#66CC00'; // Light Green
      if (elo >= 1166.3 && elo <= 1198.9) return '#CCCC00'; // Yellow-Green
      if (elo >= 1199.0 && elo <= 1231.6) return '#FF9900'; // Yellow-Orange
      if (elo >= 1231.7 && elo <= 1264.3) return '#FF4400'; // Orange-Red
      if (elo >= 1264.4 && elo <= 1297.1) return '#CC0000'; // Dark Red
      // Fallback interpolate beyond bounds
      return elo < 1101 ? '#00AA00' : '#CC0000';
    }

    async function loadData() {
      const sos = await tryCsv(['../output/sos/season2_elo.csv', 'output/sos/season2_elo.csv', '/output/sos/season2_elo.csv']);
      const teams = await tryCsv(['../MEGA_teams.csv', 'MEGA_teams.csv', '/MEGA_teams.csv']);
      const schedules = await tryJson(['../output/schedules/season2/all_schedules.json','output/schedules/season2/all_schedules.json','/output/schedules/season2/all_schedules.json']);
      // Parse mega_elo.csv (semicolon separated, decimal comma)
      let megaEloText = '';
      try {
        megaEloText = await tryText(['../mega_elo.csv','mega_elo.csv','/mega_elo.csv']);
      } catch (_) {}
      const megaEloMap = new Map();
      if (megaEloText) {
        megaEloText.split(/\r?\n/).forEach(line => {
          if (!line || line.startsWith('#')) return;
          const parts = line.split(';');
          if (parts.length < 3) return;
          const team = parts[1] && parts[1].trim();
          let ratingStr = parts[2] ? parts[2].replace(/,/g, '.').trim() : '';
          const rating = parseFloat(ratingStr);
          if (team && !isNaN(rating)) megaEloMap.set(team, rating);
        });
      }

      const teamMeta = new Map();
      for (const t of teams) {
        if (!t.displayName) continue;
        teamMeta.set(String(t.displayName).trim(), {
          logoId: t.logoId,
          conference: t.conferenceName || t.conference,
          division: t.divName || t.divisionName || t.division,
        });
      }

      for (const r of sos) {
        const name = String(r.team).trim();
        const meta = teamMeta.get(name);
        if (meta) {
          r.conference = r.conference || meta.conference || null;
          r.division = r.division || meta.division || null;
          if (meta.logoId !== undefined && meta.logoId !== null && meta.logoId !== '') {
            r.logoUrl = `https://cdn.neonsportz.com/teamlogos/256/${meta.logoId}.png`;
          }
        }
        // Attach own ELO from mega_elo.csv if available
        if (megaEloMap.has(name)) {
          r.own_elo = +megaEloMap.get(name);
        }
      }

      const conferences = Array.from(new Set(sos.map(r => (r.conference||'').toUpperCase()).filter(Boolean))).sort();
      const divisionsByConf = new Map();
      for (const conf of conferences) {
        const divs = Array.from(new Set(
          sos.filter(r => (r.conference||'').toUpperCase()===conf).map(r => r.division).filter(Boolean)
        )).sort();
        divisionsByConf.set(conf, divs);
      }

      const allDivisions = Array.from(new Set(sos.map(r => r.division).filter(Boolean))).sort();
      // Build schedules map with opponent ELO inferred when missing
      const scheduleMap = new Map();
      if (schedules && typeof schedules === 'object') {
        Object.entries(schedules).forEach(([team, rec]) => {
          const list = (rec && rec.schedule) ? rec.schedule : [];
          const normTeam = String(team).trim();
          const enriched = list.map((g, idx) => {
            const opp = String(g.opponent).trim();
            let elo = g.oppElo;
            if (elo == null && megaEloMap.has(opp)) elo = megaEloMap.get(opp);
            const meta = teamMeta.get(opp) || {};
            const logoUrl = (meta.logoId!==undefined && meta.logoId!==null && meta.logoId!=='') ? `https://cdn.neonsportz.com/teamlogos/256/${meta.logoId}.png` : null;
            return { week: idx, opponent: opp, elo: elo, homeAway: g.homeAway || '', gameId: g.gameId || '', logoUrl };
          });
          scheduleMap.set(normTeam, enriched);
        });
      }
      return { rows: sos, conferences, divisionsByConf, allDivisions, scheduleMap };
    }

    // TABLE RENDERING
    function applyFilters(rows, confSel, divSel) {
      const conf = confSel.value;
      const div = divSel.value;
      return rows.filter(r => {
        const okConf = conf === 'ALL' || (String(r.conference||'').toUpperCase() === conf);
        const okDiv = div === 'ALL' || (String(r.division||'') === div);
        return okConf && okDiv;
      });
    }

    function renderTable(tbody, rows) {
      const tr = tbody.selectAll('tr').data(rows, d => d.team).join('tr');
      tr.html('');
      tr.each(function(d){
        const row = d3.select(this);
        const teamCell = row.append('td');
        const cell = teamCell.append('div').attr('class','team-cell');
        if (d.logoUrl) cell.append('img').attr('class','logo').attr('src', d.logoUrl).attr('alt', d.team);
        cell.append('span').text(d.team);

        row.append('td').attr('class','num').style('text-align','right').text(d.games);
        row.append('td').attr('class','num').style('text-align','right').text(fmt3(+d.avg_opp_elo));
        row.append('td').attr('class','num').style('text-align','right').text((+d.plus_minus_vs_avg>=0?'+':'') + fmt3(+d.plus_minus_vs_avg));
        row.append('td').attr('class','num').style('text-align','right').text(fmt3(+d.sos_index));
        row.append('td').attr('class','num').style('text-align','right').text(d.rank);
      });
    }

    // BARS RENDERING
    function drawBars(holder, rows, cfg) {
      const data = rows.slice().sort((a,b) => (+a.rank) - (+b.rank));
      const margin = { top: 14, right: 24, bottom: 10, left: 180 };
      const rowH = 26;
      const width = 1080;
      const height = margin.top + margin.bottom + rowH * data.length + 10;
      const innerW = width - margin.left - margin.right;

      const svg = holder.append('svg').attr('width', width).attr('height', height);
      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const xDomain = d3.extent(data, d => +d.avg_opp_elo);
      const x = d3.scaleLinear().domain(xDomain).nice().range([0, innerW]);
      const y = d3.scaleBand().domain(data.map(d => d.team)).range([0, rowH * data.length]).padding(0.25);

      g.append('g')
        .attr('transform', `translate(0,0)`) 
        .call(d3.axisTop(x).ticks(6).tickSize(-rowH * data.length).tickPadding(6))
        .call(s => s.selectAll('.tick line').attr('stroke', '#efefef'))
        .call(s => s.select('.domain').attr('stroke', '#dcdcdc'));

      const leagueAvg = +data[0].league_avg_opp_elo;
      const avgX = x(leagueAvg);
      g.append('line').attr('x1', avgX).attr('x2', avgX).attr('y1', 0).attr('y2', rowH * data.length)
        .attr('stroke', '#999').attr('stroke-dasharray', '6,4').attr('stroke-width', 1.5);
      g.append('text').attr('x', avgX + 6).attr('y', 12).attr('class','avgLineLabel').text('League Avg ' + fmt3(leagueAvg));

      const tip = d3.select('body').append('div').attr('class','tooltip').style('display', 'none');

      const bar = g.selectAll('.bar').data(data, d => d.team).join('g').attr('class','bar')
        .attr('transform', d => `translate(0,${y(d.team)})`);

      bar.append('rect')
        .attr('x', 0)
        .attr('y', 0)
        .attr('width', d => x(+d.avg_opp_elo))
        .attr('height', y.bandwidth())
        .attr('fill', d => (+d.plus_minus_vs_avg >= 0) ? 'var(--red)' : 'var(--blue)')
        .attr('opacity', 0.75)
        .on('mouseenter', function(evt, d){
          const html = `<strong>${d.team}</strong>`+
            `<br>Rank: ${d.rank}`+
            `<br>Games: ${d.games}`+
            `<br>Avg Opp ELO: ${fmt3(+d.avg_opp_elo)}`+
            `<br>+/- vs Avg: ${(+d.plus_minus_vs_avg>=0?'+':'') + fmt3(+d.plus_minus_vs_avg)}`;
          tip.style('display','block').html(html);
        })
        .on('mousemove', (evt)=> tip.style('left', (evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px'))
        .on('mouseleave', ()=> tip.style('display','none'));

      const labels = svg.append('g').attr('transform', `translate(12,${margin.top})`);
      const lab = labels.selectAll('.label').data(data, d => d.team).join('g').attr('class','label')
        .attr('transform', d => `translate(0,${y(d.team) + (y.bandwidth()/2)})`);
      lab.append('image')
        .attr('href', d => d.logoUrl || null)
        .attr('x', 0)
        .attr('y', -10)
        .attr('width', 20)
        .attr('height', 20)
        .attr('opacity', .95);
      lab.append('text')
        .attr('x', 26)
        .attr('y', 4)
        .attr('fill', '#333')
        .attr('font-size', 13)
        .text(d => `#${d.rank}  ${d.team}`);

      if (cfg && cfg.title) {
        holder.append('div').style('color', '#555').style('font-size', '12px').style('margin','6px 0 0 0')
          .text(cfg.title);
      }
    }

    function setup() {
      // Tabs behavior
      function activate(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab===tabId));
        document.querySelectorAll('.view').forEach(v => v.classList.toggle('active', v.id===tabId));
      }

      document.addEventListener('click', (e) => {
        const t = e.target.closest('.tab');
        if (!t) return;
        activate(t.dataset.tab);
      });

      loadData().then(({ rows: allRows, conferences, divisionsByConf, allDivisions, scheduleMap }) => {
        // Default active tab
        activate('table-view');

        // TABLE INIT
        const confSel = d3.select('#t_conf');
        const divSel = d3.select('#t_div');
        confSel.append('option').attr('value','ALL').text('All Conferences');
        conferences.forEach(c => confSel.append('option').attr('value', c).text(c));
        function refreshDivisions() {
          const conf = confSel.property('value');
          divSel.selectAll('option').remove();
          divSel.append('option').attr('value','ALL').text('All Divisions');
          const divs = conf==='ALL' ? Array.from(new Set([].concat(...Array.from(divisionsByConf.values())))).sort()
                                    : (divisionsByConf.get(conf) || []);
          divs.forEach(d => divSel.append('option').attr('value', d).text(d));
        }
        refreshDivisions();
        const tbody = d3.select('#tbody');
        const sortState = { key: 'rank', dir: 'asc' };
        function sortRows(rows) {
          const key = sortState.key, dir = sortState.dir;
          const sign = dir === 'asc' ? 1 : -1;
          return rows.slice().sort((a,b) => {
            const av = a[key], bv = b[key];
            if (typeof av === 'number' && typeof bv === 'number') return sign * (av - bv);
            const an = +av, bn = +bv;
            if (!Number.isNaN(an) && !Number.isNaN(bn)) return sign * (an - bn);
            return sign * String(av).localeCompare(String(bv));
          });
        }
        function setSort(key, defaultDir='desc') {
          if (sortState.key === key) {
            sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
          } else {
            sortState.key = key;
            sortState.dir = defaultDir;
          }
          updateSortIndicators();
          redrawTable();
        }
        function updateSortIndicators() {
          d3.selectAll('th .sort-ind').remove();
          d3.select(`th[data-key='${sortState.key}']`).append('span').attr('class','sort-ind').text(sortState.dir==='asc' ? '▲' : '▼');
        }
        function redrawTable() {
          let rows = applyFilters(allRows, confSel.node(), divSel.node());
          rows = sortRows(rows);
          renderTable(tbody, rows);
          d3.select('#rowcount').text(rows.length);
        }
        d3.select("th[data-key='team']").on('click', () => setSort('team','asc'));
        d3.select("th[data-key='games']").on('click', () => setSort('games','desc'));
        d3.select("th[data-key='avg_opp_elo']").on('click', () => setSort('avg_opp_elo','desc'));
        d3.select("th[data-key='plus_minus_vs_avg']").on('click', () => setSort('plus_minus_vs_avg','desc'));
        d3.select("th[data-key='sos_index']").on('click', () => setSort('sos_index','desc'));
        d3.select("th[data-key='rank']").on('click', () => setSort('rank','asc'));
        updateSortIndicators();
        confSel.on('change', () => { refreshDivisions(); redrawTable(); });
        divSel.on('change', () => redrawTable());
        redrawTable();

        // BARS INIT
        const viewSel = d3.select('#b_view');
        const bConfSel = d3.select('#b_conf');
        const bDivSel = d3.select('#b_div');
        viewSel.selectAll('option').remove();
        viewSel.append('option').attr('value','LEAGUE').text('League');
        viewSel.append('option').attr('value','CONF').text('By Conference');
        viewSel.append('option').attr('value','DIV').text('By Division');
        bConfSel.selectAll('option').remove();
        conferences.forEach(c => bConfSel.append('option').attr('value', c).text(c));
        bDivSel.selectAll('option').remove();
        allDivisions.forEach(d => bDivSel.append('option').attr('value', d).text(d));

        function updateBarsVisibility() {
          const v = viewSel.property('value');
          d3.select('#b_conf_wrap').style('display', v==='CONF' ? 'inline-flex' : 'none');
          d3.select('#b_div_wrap').style('display', v==='DIV' ? 'inline-flex' : 'none');
        }
        function redrawBars() {
          const root = d3.select('#bars-root');
          root.html('');
          const panel = root.append('div').attr('class','panel');
          panel.append('div').attr('class','header').text('Season 2 — Strength of Schedule (Avg Opponent ELO)');
          const chart = panel.append('div').attr('class','chart-wrap');
          const v = viewSel.property('value');
          if (v === 'LEAGUE') {
            drawBars(chart, allRows, { title: 'League-wide (ordered by Rank)' });
          } else if (v === 'CONF') {
            const c = bConfSel.property('value');
            const rows = allRows.filter(r => String(r.conference||'').toUpperCase() === c);
            drawBars(chart, rows, { title: `${c} (ordered by Rank)` });
          } else {
            const d = bDivSel.property('value');
            const rows = allRows.filter(r => String(r.division||'') === d);
            drawBars(chart, rows, { title: `${d} (ordered by Rank)` });
          }
        }
        viewSel.on('change', () => { updateBarsVisibility(); redrawBars(); });
        bConfSel.on('change', () => redrawBars());
        bDivSel.on('change', () => redrawBars());
        updateBarsVisibility();
        redrawBars();

        // OPPONENTS INIT
        const oConfSel = d3.select('#o_conf');
        const oDivSel = d3.select('#o_div');
        oConfSel.append('option').attr('value','ALL').text('All Conferences');
        conferences.forEach(c => oConfSel.append('option').attr('value', c).text(c));
        function refreshODivisions() {
          const conf = oConfSel.property('value');
          oDivSel.selectAll('option').remove();
          oDivSel.append('option').attr('value','ALL').text('All Divisions');
          const divs = conf==='ALL' ? Array.from(new Set([].concat(...Array.from(divisionsByConf.values())))).sort()
                                    : (divisionsByConf.get(conf) || []);
          divs.forEach(d => oDivSel.append('option').attr('value', d).text(d));
        }
        refreshODivisions();
        const oTbody = d3.select('#opp-tbody');
        function renderOppTable(rows) {
          const tr = oTbody.selectAll('tr').data(rows, d => d.team).join('tr');
          tr.html('');
          tr.each(function(d){
            const row = d3.select(this);
            const cell = row.append('td');
            const teamCell = cell.append('div').attr('class','team-cell');
            if (d.logoUrl) teamCell.append('img').attr('class','logo').attr('src', d.logoUrl).attr('alt', d.team);
            teamCell.append('span').text(d.team);

            const opps = scheduleMap.get(d.team) || [];
            const oppCell = row.append('td');
            const wrap = oppCell.append('div').attr('class','opp-row');
            opps.forEach(g => {
              const badge = wrap.append('div').attr('class','opp-badge').style('background', colorForElo(+g.elo)).style('border-color', 'rgba(0,0,0,.12)');
              if (g.logoUrl) badge.append('img').attr('class','opp-logo').attr('src', g.logoUrl).attr('alt', g.opponent);
              badge.append('span').text(g.opponent);
              badge.append('span').attr('class','opp-elo').text(isFinite(+g.elo) ? fmt1(+g.elo) : '—');
            });
          });
        }
        function redrawOppTable() {
          let rows = applyFilters(allRows, oConfSel.node(), oDivSel.node());
          // Enrich with logoUrl if not already
          rows = rows.map(r => r);
          renderOppTable(rows);
          d3.select('#opp-rowcount').text(rows.length);
        }
        oConfSel.on('change', () => { refreshODivisions(); redrawOppTable(); });
        oDivSel.on('change', () => redrawOppTable());
        redrawOppTable();

        // SCATTER INIT (Own ELO vs SoS)
        const sConfSel = d3.select('#s_conf');
        const sDivSel = d3.select('#s_div');
        sConfSel.append('option').attr('value','ALL').text('All Conferences');
        conferences.forEach(c => sConfSel.append('option').attr('value', c).text(c));
        function refreshSDivisions() {
          const conf = sConfSel.property('value');
          sDivSel.selectAll('option').remove();
          sDivSel.append('option').attr('value','ALL').text('All Divisions');
          const divs = conf==='ALL' ? Array.from(new Set([].concat(...Array.from(divisionsByConf.values())))).sort()
                                    : (divisionsByConf.get(conf) || []);
          divs.forEach(d => sDivSel.append('option').attr('value', d).text(d));
        }
        refreshSDivisions();

        function drawScatter(holder, rows) {
          const data = rows.filter(d => isFinite(+d.own_elo) && isFinite(+d.avg_opp_elo));
          const margin = { top: 24, right: 28, bottom: 40, left: 48 };
          const width = 880;
          const height = 520;
          const innerW = width - margin.left - margin.right;
          const innerH = height - margin.top - margin.bottom;

          // X domain auto from data; Y domain fixed to requested SoS range 1185–1215
          const xMin = d3.min(data, d => +d.own_elo);
          const xMax = d3.max(data, d => +d.own_elo);
          const xPad = (xMax - xMin) * 0.05;
          const xDomain = [xMin - xPad, xMax + xPad];
          const yDomain = [1185, 1215];

          const x = d3.scaleLinear().domain(xDomain).nice().range([0, innerW]);
          const y = d3.scaleLinear().domain(yDomain).nice().range([innerH, 0]);

          const svg = holder.append('svg').attr('width', width).attr('height', height);
          const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

          // Grid
          g.append('g')
            .attr('transform', `translate(0,${innerH})`)
            .call(d3.axisBottom(x).ticks(6).tickSize(-innerH).tickPadding(6))
            .call(s => s.selectAll('.tick line').attr('stroke', '#efefef'))
            .call(s => s.select('.domain').attr('stroke', '#dcdcdc'));
          g.append('g')
            .call(d3.axisLeft(y).ticks(6).tickSize(-innerW).tickPadding(6))
            .call(s => s.selectAll('.tick line').attr('stroke', '#efefef'))
            .call(s => s.select('.domain').attr('stroke', '#dcdcdc'));

          // Axis labels
          svg.append('text').attr('x', margin.left + innerW/2).attr('y', height - 6)
            .attr('text-anchor','middle').attr('fill','#555').attr('font-size',12)
            .text('Own ELO');
          svg.append('text').attr('transform', `translate(14,${margin.top + innerH/2}) rotate(-90)`) 
            .attr('text-anchor','middle').attr('fill','#555').attr('font-size',12)
            .text('SoS (Avg Opponent ELO)');

          // Diagonal y = x (clipped to the visible x/y domains)
          const seg0 = Math.max(x.domain()[0], y.domain()[0]);
          const seg1 = Math.min(x.domain()[1], y.domain()[1]);
          g.append('line')
            .attr('x1', x(seg0))
            .attr('y1', y(seg0))
            .attr('x2', x(seg1))
            .attr('y2', y(seg1))
            .attr('stroke', '#888')
            .attr('stroke-dasharray', '6,4')
            .attr('stroke-width', 1.5);
          g.append('text')
            .attr('x', x(seg1) - 60)
            .attr('y', y(seg1) + 14)
            .attr('fill', '#666')
            .attr('font-size', 11)
            .text('y = x');

          const tip = d3.select('body').append('div').attr('class','tooltip').style('display','none');

          const node = g.selectAll('.pt').data(data, d => d.team).join('g').attr('class','pt')
            .attr('transform', d => `translate(${x(+d.own_elo)},${y(+d.avg_opp_elo)})`);

          node.append('circle')
            .attr('r', 8)
            .attr('fill', d => (+d.avg_opp_elo - +d.own_elo) >= 0 ? 'var(--red)' : 'var(--blue)')
            .attr('opacity', 0.25);

          node.append('image')
            .attr('href', d => d.logoUrl || null)
            .attr('x', -10)
            .attr('y', -10)
            .attr('width', 20)
            .attr('height', 20)
            .attr('opacity', 0.95)
            .on('mouseenter', function(evt, d){
              const delta = (+d.avg_opp_elo - +d.own_elo);
              const html = `<strong>${d.team}</strong>`+
                `<br>Own ELO: ${fmt1(+d.own_elo)}`+
                `<br>Avg Opp ELO: ${fmt1(+d.avg_opp_elo)}`+
                `<br>Δ (SoS - Own): ${(delta>=0?'+':'') + fmt1(delta)}`;
              tip.style('display','block').html(html);
            })
            .on('mousemove', (evt)=> tip.style('left', (evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px'))
            .on('mouseleave', ()=> tip.style('display','none'));

          const legend = d3.select('#scatter-legend');
          legend.html('');
          legend.append('span').html(`<span class="swatch" style="background: var(--red);"></span>Above y=x (harder)`);
          legend.append('span').style('margin-left','16px').html(`<span class="swatch" style="background: var(--blue);"></span>Below y=x (easier)`);
        }

        function redrawScatter() {
          const root = d3.select('#scatter-root');
          root.html('');
          let rows = applyFilters(allRows, sConfSel.node(), sDivSel.node());
          const panel = root.append('div').attr('class','panel');
          panel.append('div').attr('class','header').text('Own ELO vs SoS (Avg Opp ELO) — y = x Reference');
          const chart = panel.append('div').attr('class','chart-wrap');
          drawScatter(chart, rows);
          d3.select('#scatter-rowcount').text(rows.length);
        }

        sConfSel.on('change', () => { refreshSDivisions(); redrawScatter(); });
        sDivSel.on('change', () => redrawScatter());
        redrawScatter();
      }).catch(err => {
        console.error(err);
        d3.select('#error').text('Error loading data: ' + err);
      });
    }

    window.addEventListener('DOMContentLoaded', setup);
  </script>
</head>
<body>
  <div class="container">
    <h1>Season 2 Strength of Schedule — Combined</h1>
    <div class="subtitle">One page with both a sortable table and D3 bar charts. Data: output/sos/season2_elo.csv + MEGA_teams.csv</div>

    <div class="tabs">
      <div class="tab active" data-tab="table-view">Table</div>
      <div class="tab" data-tab="bars-view">Bars</div>
      <div class="tab" data-tab="opps-view">Opponents</div>
      <div class="tab" data-tab="scatter-view">Scatter</div>
    </div>

    <div id="table-view" class="view active">
      <div class="controls">
        <div>
          <label for="t_conf">Conference</label>
          <select id="t_conf"></select>
        </div>
        <div>
          <label for="t_div">Division</label>
          <select id="t_div"></select>
        </div>
        <div class="muted">Rows: <span id="rowcount">0</span></div>
        <div id="error" class="muted"></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th data-key="team">Team</th>
              <th class="num" data-key="games">Games</th>
              <th class="num" data-key="avg_opp_elo">Avg Opp ELO</th>
              <th class="num" data-key="plus_minus_vs_avg">+/- vs Avg</th>
              <th class="num" data-key="sos_index">SoS Index</th>
              <th class="num" data-key="rank">Rank</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="subtitle" style="margin-top:8px">Tip: Click a column header to sort. Default is by Rank (ascending).</div>
    </div>

    <div id="bars-view" class="view">
      <div class="controls">
        <div>
          <label for="b_view">View</label>
          <select id="b_view"></select>
        </div>
        <div id="b_conf_wrap" style="display:none">
          <label for="b_conf">Conference</label>
          <select id="b_conf"></select>
        </div>
        <div id="b_div_wrap" style="display:none">
          <label for="b_div">Division</label>
          <select id="b_div"></select>
        </div>
      </div>
      <div class="legend">
        <span><span class="swatch" style="background: var(--red);"></span>Harder than league average</span>
        <span><span class="swatch" style="background: var(--blue);"></span>Easier than league average</span>
        <span><span class="swatch" style="background: repeating-linear-gradient(90deg, #bbb, #bbb 2px, transparent 2px, transparent 6px); border: 1px solid #bbb;"></span>League average</span>
      </div>
      <div id="bars-root"></div>
    </div>

    <div id="opps-view" class="view">
      <div class="controls">
        <div>
          <label for="o_conf">Conference</label>
          <select id="o_conf"></select>
        </div>
        <div>
          <label for="o_div">Division</label>
          <select id="o_div"></select>
        </div>
        <div class="muted">Rows: <span id="opp-rowcount">0</span></div>
      </div>
      <div class="opp-legend">
        <span><span class="opp-swatch" style="background:#00AA00"></span>1101.0–1133.5</span>
        <span><span class="opp-swatch" style="background:#66CC00"></span>1133.6–1166.2</span>
        <span><span class="opp-swatch" style="background:#CCCC00"></span>1166.3–1198.9</span>
        <span><span class="opp-swatch" style="background:#FF9900"></span>1199.0–1231.6</span>
        <span><span class="opp-swatch" style="background:#FF4400"></span>1231.7–1264.3</span>
        <span><span class="opp-swatch" style="background:#CC0000"></span>1264.4–1297.1</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Team</th>
              <th>Opponents (ELO-colored)</th>
            </tr>
          </thead>
          <tbody id="opp-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="scatter-view" class="view">
      <div class="controls">
        <div>
          <label for="s_conf">Conference</label>
          <select id="s_conf"></select>
        </div>
        <div>
          <label for="s_div">Division</label>
          <select id="s_div"></select>
        </div>
        <div class="muted">Teams: <span id="scatter-rowcount">0</span></div>
      </div>
      <div class="legend" id="scatter-legend"></div>
      <div id="scatter-root"></div>
      <div class="subtitle" style="margin-top:8px">X: Own ELO, Y: Avg Opponent ELO (SoS). Points above y=x face tougher schedules relative to their rating.</div>
    </div>
  </div>
</body>
</html>
