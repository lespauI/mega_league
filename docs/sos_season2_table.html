<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Season 2 Strength of Schedule — Table</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root {
      --bg: #f7f7f7;
      --card: #fff;
      --border: #e5e5e5;
      --muted: #666;
      --muted2: #999;
      --text: #1a1a1a;
      --accent: #0ea5e9;
      --hover: #fafafa;
    }
    body { margin: 16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--text); background: var(--bg); }
    .container { max-width: 1200px; margin: 0 auto; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px 18px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
    h1 { margin: 0 0 4px; font-size: 22px; }
    .subtitle { color: var(--muted); font-size: 13px; margin: 2px 0 10px; }
    .controls { display: flex; gap: 10px; align-items: center; margin: 6px 0 12px; flex-wrap: wrap; }
    .controls label { font-size: 13px; color: var(--muted); margin-right: 4px; }
    select { padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; }
    .table-wrap { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: #fff; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { background: #fafafa; color: #555; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; font-size: 11px; padding: 9px 8px; text-align: left; border-bottom: 2px solid var(--border); user-select: none; cursor: pointer; }
    thead th.num { text-align: right; }
    tbody td { padding: 10px 8px; border-bottom: 1px solid #f1f1f1; }
    tbody tr:hover { background: var(--hover); }
    .team-cell { display: flex; align-items: center; gap: 8px; font-weight: 600; }
    .logo { width: 26px; height: 26px; object-fit: contain; }
    .muted { color: var(--muted2); font-size: 12px; }
    .sort-ind { color: var(--accent); margin-left: 4px; font-size: 11px; }
    .footer { color: var(--muted); font-size: 12px; margin-top: 8px; }
  </style>
  <!-- Serve from repo root: python3 -m http.server 8000 -->
  <script>
    // Robust CSV loader trying multiple relative paths
    async function tryCsv(paths) {
      let lastErr;
      for (const p of paths) {
        try { return await d3.csv(p, d3.autoType); } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Unable to load CSV: ' + paths.join(', '));
    }

    function fmt3(x) { return d3.format('.3f')(x); }

    async function loadData() {
      const sos = await tryCsv(['../output/sos/season2_elo.csv', 'output/sos/season2_elo.csv', '/output/sos/season2_elo.csv']);
      const teams = await tryCsv(['../MEGA_teams.csv', 'MEGA_teams.csv', '/MEGA_teams.csv']);

      const teamMeta = new Map();
      for (const t of teams) {
        if (!t.displayName) continue;
        teamMeta.set(String(t.displayName).trim(), {
          logoId: t.logoId,
          conference: t.conferenceName || t.conference,
          division: t.divName || t.divisionName || t.division,
        });
      }

      // Enrich SoS rows with logo and normalize conference/division
      for (const r of sos) {
        const name = String(r.team).trim();
        const meta = teamMeta.get(name);
        if (meta) {
          r.conference = r.conference || meta.conference || null;
          r.division = r.division || meta.division || null;
          if (meta.logoId !== undefined && meta.logoId !== null && meta.logoId !== '') {
            r.logoUrl = `https://cdn.neonsportz.com/teamlogos/256/${meta.logoId}.png`;
          }
        }
      }

      // Build filter domain lists
      const conferences = Array.from(new Set(sos.map(r => (r.conference||'').toUpperCase()).filter(Boolean))).sort();
      const divisionsByConf = new Map();
      for (const conf of conferences) {
        const divs = Array.from(new Set(
          sos.filter(r => (r.conference||'').toUpperCase()===conf).map(r => r.division).filter(Boolean)
        )).sort();
        divisionsByConf.set(conf, divs);
      }

      return { rows: sos, conferences, divisionsByConf };
    }

    function applyFilters(rows, confSel, divSel) {
      const conf = confSel.value;
      const div = divSel.value;
      return rows.filter(r => {
        const okConf = conf === 'ALL' || (String(r.conference||'').toUpperCase() === conf);
        const okDiv = div === 'ALL' || (String(r.division||'') === div);
        return okConf && okDiv;
      });
    }

    function renderTable(tbody, rows) {
      const tr = tbody.selectAll('tr').data(rows, d => d.team).join('tr');
      tr.html('');
      tr.each(function(d){
        const row = d3.select(this);
        const teamCell = row.append('td');
        const cell = teamCell.append('div').attr('class','team-cell');
        if (d.logoUrl) cell.append('img').attr('class','logo').attr('src', d.logoUrl).attr('alt', d.team);
        cell.append('span').text(d.team);

        row.append('td').attr('class','num').style('text-align','right').text(d.games);
        row.append('td').attr('class','num').style('text-align','right').text(fmt3(+d.avg_opp_elo));
        row.append('td').attr('class','num').style('text-align','right').text((+d.plus_minus_vs_avg>=0?'+':'') + fmt3(+d.plus_minus_vs_avg));
        row.append('td').attr('class','num').style('text-align','right').text(fmt3(+d.sos_index));
        row.append('td').attr('class','num').style('text-align','right').text(d.rank);
      });
    }

    function setup() {
      loadData().then(({ rows: allRows, conferences, divisionsByConf }) => {
        // Controls
        const confSel = d3.select('#conf');
        confSel.append('option').attr('value','ALL').text('All Conferences');
        conferences.forEach(c => confSel.append('option').attr('value', c).text(c));

        const divSel = d3.select('#div');
        function refreshDivisions() {
          const conf = confSel.property('value');
          divSel.selectAll('option').remove();
          divSel.append('option').attr('value','ALL').text('All Divisions');
          const divs = conf==='ALL' ? Array.from(new Set([].concat(...Array.from(divisionsByConf.values())))).sort()
                                    : (divisionsByConf.get(conf) || []);
          divs.forEach(d => divSel.append('option').attr('value', d).text(d));
        }
        refreshDivisions();
        confSel.on('change', () => { refreshDivisions(); redraw(); });
        divSel.on('change', () => redraw());

        // Table/sort
        const tbody = d3.select('#tbody');
        const sortState = { key: 'rank', dir: 'asc' };

        function sortRows(rows) {
          const key = sortState.key, dir = sortState.dir;
          const sign = dir === 'asc' ? 1 : -1;
          return rows.slice().sort((a,b) => {
            const av = a[key], bv = b[key];
            if (typeof av === 'number' && typeof bv === 'number') return sign * (av - bv);
            const an = +av, bn = +bv;
            if (!Number.isNaN(an) && !Number.isNaN(bn)) return sign * (an - bn);
            return sign * String(av).localeCompare(String(bv));
          });
        }

        function setSort(key, defaultDir='desc') {
          if (sortState.key === key) {
            sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
          } else {
            sortState.key = key;
            sortState.dir = defaultDir;
          }
          updateSortIndicators();
          redraw();
        }

        function updateSortIndicators() {
          d3.selectAll('th .sort-ind').remove();
          d3.select(`th[data-key='${sortState.key}']`).append('span').attr('class','sort-ind').text(sortState.dir==='asc' ? '▲' : '▼');
        }

        function redraw() {
          let rows = applyFilters(allRows, confSel.node(), divSel.node());
          rows = sortRows(rows);
          renderTable(tbody, rows);
          d3.select('#rowcount').text(rows.length);
        }

        // Attach sort handlers
        d3.select("th[data-key='team']").on('click', () => setSort('team','asc'));
        d3.select("th[data-key='games']").on('click', () => setSort('games','desc'));
        d3.select("th[data-key='avg_opp_elo']").on('click', () => setSort('avg_opp_elo','desc'));
        d3.select("th[data-key='plus_minus_vs_avg']").on('click', () => setSort('plus_minus_vs_avg','desc'));
        d3.select("th[data-key='sos_index']").on('click', () => setSort('sos_index','desc'));
        d3.select("th[data-key='rank']").on('click', () => setSort('rank','asc'));

        updateSortIndicators();
        redraw();
      }).catch(err => {
        console.error(err);
        d3.select('#error').text('Error loading data: ' + err);
      });
    }

    window.addEventListener('DOMContentLoaded', setup);
  </script>
</head>
<body>
  <div class="container">
    <h1>Season 2 Strength of Schedule — Table</h1>
    <div class="subtitle">Sortable table with conference/division filters. Data: output/sos/season2_elo.csv + MEGA_teams.csv</div>
    <div class="controls">
      <div>
        <label for="conf">Conference</label>
        <select id="conf"></select>
      </div>
      <div>
        <label for="div">Division</label>
        <select id="div"></select>
      </div>
      <div class="muted">Rows: <span id="rowcount">0</span></div>
      <div id="error" class="muted"></div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th data-key="team">Team</th>
            <th class="num" data-key="games">Games</th>
            <th class="num" data-key="avg_opp_elo">Avg Opp ELO</th>
            <th class="num" data-key="plus_minus_vs_avg">+/- vs Avg</th>
            <th class="num" data-key="sos_index">SoS Index</th>
            <th class="num" data-key="rank">Rank</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="footer">Tip: Click a column header to sort. Default is by Rank (ascending).</div>
  </div>
</body>
</html>

