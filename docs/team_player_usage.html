<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Player Usage Patterns</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root {
      --red: #ef4444;
      --blue: #0ea5e9;
      --grid: #e8eaed;
      --axis: #9aa0a6;
      --text: #222;
    }
    body { margin: 16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--text); background: #f7f7f7; }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px 16px 22px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
    h1 { margin: 0 0 10px; font-size: 22px; }
    .subtitle { color: #666; font-size: 13px; margin: 4px 0 12px; }
    .controls { display: flex; align-items: center; gap: 10px; margin: 6px 0 8px; }
    .panel { margin: 12px 0 14px; border: 1px solid #e5e5e5; border-radius: 10px; overflow: hidden; background: #fff; }
    .panel > summary { padding: 10px 14px; background: #f5f7fa; border-bottom: 1px solid #ebeff5; font-weight: 600; cursor: pointer; user-select: none; list-style: none; }
    .panel[open] > summary { border-bottom-color: #e6eaf0; }
    .chart-wrap { padding: 8px 8px 0; }
    .legend { display: flex; align-items: center; gap: 16px; color: #555; font-size: 12px; padding: 0 10px 10px; }
    .swatch { display: inline-block; width: 12px; height: 12px; border-radius: 2px; margin-right: 6px; vertical-align: middle; }
    .avg { background: repeating-linear-gradient(90deg, #bbb, #bbb 2px, transparent 2px, transparent 6px); border: 1px solid #bbb; }
    .red { background: var(--red); opacity: .5; }
    .blue { background: var(--blue); opacity: .5; }
    .tooltip { position: absolute; pointer-events: none; background: rgba(0,0,0,.78); color: #fff; padding: 6px 8px; border-radius: 6px; font-size: 12px; z-index: 10; }
    .info { background: #f3f6fa; border: 1px solid #e1e7ef; border-radius: 8px; padding: 10px 14px; color: #243246; font-size: 14px; margin: 8px 0 12px; }
    .correlation-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .corr-strong { background: #dcfce7; color: #166534; }
    .corr-moderate { background: #fef3c7; color: #854d0e; }
    .corr-weak { background: #fee2e2; color: #991b1b; }
  </style>
  <script>
    async function tryCsv(paths) {
      let lastErr;
      for (const p of paths) {
        try { return await d3.csv(p, d3.autoType); } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Unable to load CSV: ' + paths.join(', '));
    }

    function fmt1(x) { return d3.format('.1f')(x); }
    function fmt2(x) { return d3.format('.2f')(x); }
    function fmt3(x) { return d3.format('.3f')(x); }
    function toPct(x) { return d3.format('.1%')(x); }
    function toPct0(x) { return d3.format('.0%')(x); }

    function regression(points) {
      let n = 0, sx = 0, sy = 0, sxy = 0, sxx = 0, syy = 0;
      for (const [x0, y0] of points) {
        const x = +x0, y = +y0;
        if (!Number.isFinite(x) || !Number.isFinite(y)) continue;
        n++; sx += x; sy += y; sxy += x*y; sxx += x*x; syy += y*y;
      }
      if (n < 2) return { m: 0, b: sy / (n || 1), r2: 0 };
      const denom = n * sxx - sx * sx;
      const m = denom !== 0 ? (n * sxy - sx * sy) / denom : 0;
      const b = (sy - m * sx) / n;
      
      const ssr = points.reduce((sum, [x0, y0]) => {
        const x = +x0, y = +y0;
        if (!Number.isFinite(x) || !Number.isFinite(y)) return sum;
        return sum + Math.pow(y - (m * x + b), 2);
      }, 0);
      const sst = syy - (sy * sy) / n;
      const r2 = sst !== 0 ? Math.max(0, 1 - ssr / sst) : 0;
      
      return { m, b, r2 };
    }

    async function loadData() {
      const stats = await tryCsv([
        '../output/team_player_usage.csv',
        'output/team_player_usage.csv',
        '/output/team_player_usage.csv'
      ]);

      for (const row of stats) {
        row.logoUrl = (row.logoId !== '' && row.logoId != null) ? 
          `https://cdn.neonsportz.com/teamlogos/256/${row.logoId}.png` : null;
      }

      return stats;
    }

    function drawScatter(holder, rows, cfg) {
      rows = rows.filter(d => 
        Number.isFinite(+d[cfg.xKey]) && Number.isFinite(+d[cfg.yKey])
      );

      if (rows.length < 2) return;

      const margin = { top: 20, right: 24, bottom: 46, left: 70 };
      const width = 1080, height = 480;
      const innerW = width - margin.left - margin.right;
      const innerH = height - margin.top - margin.bottom;

      const panel = holder.append('details').attr('class', 'panel').attr('open', true);
      const summary = panel.append('summary');
      summary.append('span').text(cfg.title);
      
      const wrap = panel.append('div').attr('class', 'chart-wrap');
      const svg = wrap.append('svg').attr('width', width).attr('height', height);
      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const yVals = rows.map(d => +d[cfg.yKey]);
      const yMin = d3.min(yVals), yMax = d3.max(yVals);
      const yRange = yMax - yMin;
      const yPad = yRange * 0.15 || 0.5;
      const y = d3.scaleLinear()
        .domain([yMin - yPad, yMax + yPad])
        .range([innerH, 0]);

      const xVals = rows.map(d => +d[cfg.xKey]);
      const xMin = d3.min(xVals), xMax = d3.max(xVals);
      const xRange = xMax - xMin;
      const xPad = xRange * 0.15 || 0.5;
      const x = d3.scaleLinear()
        .domain([xMin - xPad, xMax + xPad])
        .range([0, innerW]);

      g.append('g').attr('transform', `translate(0,${innerH})`)
        .call(d3.axisBottom(x).ticks(10).tickFormat(cfg.xFormat || fmt2).tickSize(-innerH).tickPadding(8))
        .call(s => s.selectAll('.tick line').attr('stroke', '#e2e2e2'))
        .call(s => s.select('.domain').attr('stroke', '#9aa0a6'));

      g.append('g')
        .call(d3.axisLeft(y).ticks(10).tickFormat(cfg.yFormat || fmt2).tickSize(-innerW).tickPadding(6))
        .call(s => s.selectAll('.tick line').attr('stroke', '#efefef'))
        .call(s => s.select('.domain').attr('stroke', '#dcdcdc'));

      const yAvg = d3.mean(yVals), xAvg = d3.mean(xVals);
      g.append('line').attr('x1', 0).attr('x2', innerW).attr('y1', y(yAvg)).attr('y2', y(yAvg))
        .attr('stroke', '#999').attr('stroke-dasharray', '6,4').attr('stroke-width', 1.5);
      g.append('line').attr('x1', x(xAvg)).attr('x2', x(xAvg)).attr('y1', 0).attr('y2', innerH)
        .attr('stroke', '#9aa0a6').attr('stroke-dasharray', '6,4').attr('stroke-width', 1.5);
      g.append('text').attr('x', 6).attr('y', y(yAvg)-6).attr('fill', '#555').attr('font-size', 11)
        .text('Avg Y: ' + (cfg.yFormat || fmt2)(yAvg));
      g.append('text').attr('x', x(xAvg)+6).attr('y', 12).attr('fill', '#555').attr('font-size', 11)
        .text('Avg X: ' + (cfg.xFormat || fmt2)(xAvg));

      const { m, b, r2 } = regression(rows.map(d => [+d[cfg.xKey], +d[cfg.yKey]]));
      const xRangePts = [d3.min(xVals), d3.max(xVals)];
      g.append('line')
        .attr('x1', x(xRangePts[0])).attr('y1', y(m*xRangePts[0] + b))
        .attr('x2', x(xRangePts[1])).attr('y2', y(m*xRangePts[1] + b))
        .attr('stroke', '#777').attr('stroke-width', 2).attr('opacity', .95);

      const tip = d3.select('body').append('div').attr('class', 'tooltip').style('display', 'none');

      const size = 30;
      const node = g.selectAll('.team').data(rows, d => d.team).join('g').attr('class', 'team')
        .attr('transform', d => `translate(${x(d[cfg.xKey])},${y(d[cfg.yKey])})`)
        .on('mouseenter', function(evt, d){
          const trend = m * d[cfg.xKey] + b;
          const res = d[cfg.yKey] - trend;
          let html = `<strong>${d.team}</strong><br>`;
          html += `${cfg.xLabel}: ${(cfg.xFormat || fmt2)(d[cfg.xKey])}<br>`;
          html += `${cfg.yLabel}: ${(cfg.yFormat || fmt2)(d[cfg.yKey])}<br>`;
          html += `Win%: ${toPct(d.win_pct)}<br>`;
          if (cfg.extraInfo) html += cfg.extraInfo(d) + '<br>';
          html += `Î” vs trend: ${(res>=0?'+':'') + fmt2(res)}`;
          tip.style('display','block').html(html);
        })
        .on('mousemove', (evt)=> tip.style('left', (evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px'))
        .on('mouseleave', ()=> tip.style('display','none'));

      node.append('rect')
        .attr('x', -(size/2 + 2)).attr('y', -(size/2 + 2))
        .attr('width', size + 4).attr('height', size + 4)
        .attr('rx', 4).attr('ry', 4)
        .attr('fill', d => (+d[cfg.yKey] >= m*+d[cfg.xKey] + b) ? 'var(--red)' : 'var(--blue)')
        .attr('opacity', .16);

      node.append('image')
        .attr('href', d => d.logoUrl || null)
        .attr('x', -size/2).attr('y', -size/2)
        .attr('width', size).attr('height', size)
        .attr('opacity', .95);

      svg.append('text').attr('x', margin.left + innerW/2).attr('y', height-10)
        .attr('text-anchor', 'middle').attr('fill', '#444').attr('font-size', 12)
        .text(cfg.xLabel);
      svg.append('text').attr('transform', `translate(14, ${margin.top + innerH/2}) rotate(-90)`)
        .attr('text-anchor', 'middle').attr('fill', '#444').attr('font-size', 12)
        .text(cfg.yLabel);

      const legend = panel.append('div').attr('class', 'legend');
      legend.append('span').html('<span class="swatch red"></span> Above Trend');
      legend.append('span').html('<span class="swatch blue"></span> Below Trend');
      legend.append('span').html('<span class="swatch avg"></span> Average Lines');
      
      let corrClass = 'corr-weak', corrLabel = 'Weak';
      if (r2 >= 0.5) { corrClass = 'corr-strong'; corrLabel = 'Strong'; }
      else if (r2 >= 0.25) { corrClass = 'corr-moderate'; corrLabel = 'Moderate'; }
      
      summary.append('span').attr('class', `correlation-badge ${corrClass}`)
        .style('margin-left', '12px')
        .html(`RÂ²=${fmt3(r2)} (${corrLabel})`);

      if (cfg.insight) {
        panel.append('div').style('padding', '8px 14px 10px').style('font-size', '13px')
          .style('color', '#555').style('font-style', 'italic').text('ðŸ’¡ ' + cfg.insight);
      }
    }

    function render() {
      loadData().then(allRows => {
        const charts = [
          {
            xKey: 'wr1_share',
            yKey: 'win_pct',
            xLabel: 'WR1 Target Share (%)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Star Receiver Dependency',
            insight: 'Do teams need a dominant WR1 to win? Or is spreading the ball better?',
            extraInfo: d => `WR1: ${d.wr1_name} (${d.wr1_position})`
          },
          {
            xKey: 'te_target_share',
            yKey: 'win_pct',
            xLabel: 'TE Target Share (%)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Tight End Usage vs Winning',
            insight: 'Elite TEs are game-changers. Do teams that feature their TE win more?'
          },
          {
            xKey: 'rb_target_share',
            yKey: 'win_pct',
            xLabel: 'RB Target Share (% of catches)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Running Back Receiving Usage',
            insight: 'Pass-catching RBs create mismatches. Does featuring RBs in passing game correlate with wins?'
          },
          {
            xKey: 'pass_concentration',
            yKey: 'win_pct',
            xLabel: 'Pass Concentration (Herfindahl Index)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Passing Target Distribution',
            insight: 'Concentrated (high) = one star. Spread (low) = balanced. Which strategy wins more?'
          },
          {
            xKey: 'rb1_share',
            yKey: 'win_pct',
            xLabel: 'RB1 Rush Share (%)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Bellcow RB vs Committee Approach',
            insight: 'Feature back (70%+) vs RBBC (50-60%). Does workhorse RB strategy win more?',
            extraInfo: d => `RB1: ${d.rb1_name} (${d.rb1_position}) - ${d.rush_distribution_style}`
          },
          {
            xKey: 'top3_share',
            yKey: 'win_pct',
            xLabel: 'Top 3 Receivers Target Share (%)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Top 3 Receiver Dominance',
            insight: 'High concentration in top 3 = star-driven offense. Low = depth & spreading the ball.'
          },
          {
            xKey: 'pass_concentration',
            yKey: 'rush_concentration',
            xLabel: 'Pass Concentration',
            yLabel: 'Rush Concentration',
            xFormat: fmt1,
            title: 'Offensive Philosophy: Concentration Strategy',
            insight: 'Top-right = star-driven (both pass & rush). Bottom-left = committee approach on both.'
          },
          {
            xKey: 'wr_target_share',
            yKey: 'te_target_share',
            xLabel: 'WR Target Share (%)',
            yLabel: 'TE Target Share (%)',
            xFormat: fmt1,
            title: 'WR vs TE Usage Balance',
            insight: 'WR-heavy offense (high X, low Y) vs TE-heavy (low X, high Y). Strategic preference.'
          },
          {
            xKey: 'wr1_share',
            yKey: 'top3_share',
            xLabel: 'WR1 Share (%)',
            yLabel: 'Top 3 Share (%)',
            xFormat: fmt1,
            title: 'Alpha Receiver vs Supporting Cast',
            insight: 'High both = one star + good #2/#3. High top3, low WR1 = balanced trio.'
          },
          {
            xKey: 'rb1_share',
            yKey: 'rb2_share',
            xLabel: 'RB1 Rush Share (%)',
            yLabel: 'RB2 Rush Share (%)',
            xFormat: fmt1,
            title: 'Running Back Committee Analysis',
            insight: 'Top-right quadrant = true RBBC (both get work). High X, low Y = clear bellcow.'
          }
        ];

        const root = d3.select('#root');
        const sel = d3.select('#conf');

        function redraw() {
          const conf = sel.node().value;
          root.selectAll('*').remove();
          const filtered = conf === 'ALL' ? allRows : allRows.filter(d => d.conference === conf);
          charts.forEach(cfg => drawScatter(root, filtered, cfg));
        }

        sel.on('change', redraw);
        redraw();
      });
    }

    document.addEventListener('DOMContentLoaded', render);
  </script>
</head>
<body>
  <div class="container">
    <h1>Team Player Usage Patterns</h1>
    <div class="subtitle">
      10 graphs showing how teams distribute touches across players. Red = above trend, Blue = below trend.
      Reveals star-driven vs committee approaches.
    </div>
    <div class="controls">
      <label for="conf">Conference:</label>
      <select id="conf">
        <option value="ALL" selected>All Conferences</option>
        <option value="AFC">AFC only</option>
        <option value="NFC">NFC only</option>
      </select>
    </div>
    <div class="info">
      <strong>Usage Patterns Explained:</strong>
      <ul style="margin: 6px 0 0; padding-left: 20px; line-height: 1.6;">
        <li><strong>Star-Driven</strong>: High concentration (Herfindahl > 1500) - One dominant player gets majority of touches</li>
        <li><strong>Balanced</strong>: Moderate concentration (1000-1500) - Feature player with solid supporting cast</li>
        <li><strong>Committee/Spread</strong>: Low concentration (< 1000) - Multiple players share workload evenly</li>
        <li><strong>Bellcow RB</strong>: RB1 gets 70%+ of rushes - Traditional workhorse back</li>
        <li><strong>RBBC (Running Back By Committee)</strong>: RB1 < 60%, RB2 > 25% - Split backfield</li>
      </ul>
    </div>
    <div id="root"></div>
  </div>
</body>
</html>
