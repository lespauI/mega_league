<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Player Usage Patterns</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root {
      --red: #ef4444;
      --blue: #0ea5e9;
      --grid: #e8eaed;
      --axis: #9aa0a6;
      --text: #222;
    }
    body { margin: 16px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--text); background: #f7f7f7; }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px 16px 22px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
    h1 { margin: 0 0 10px; font-size: 22px; }
    .subtitle { color: #666; font-size: 13px; margin: 4px 0 12px; }
    .controls { display: flex; align-items: center; gap: 10px; margin: 6px 0 8px; }
    .panel { margin: 12px 0 14px; border: 1px solid #e5e5e5; border-radius: 10px; overflow: hidden; background: #fff; }
    .panel > summary { padding: 10px 14px; background: #f5f7fa; border-bottom: 1px solid #ebeff5; font-weight: 600; cursor: pointer; user-select: none; list-style: none; }
    .panel[open] > summary { border-bottom-color: #e6eaf0; }
    .chart-wrap { padding: 8px 8px 0; }
    .legend { display: flex; align-items: center; gap: 16px; color: #555; font-size: 12px; padding: 0 10px 10px; }
    .swatch { display: inline-block; width: 12px; height: 12px; border-radius: 2px; margin-right: 6px; vertical-align: middle; }
    .avg { background: repeating-linear-gradient(90deg, #bbb, #bbb 2px, transparent 2px, transparent 6px); border: 1px solid #bbb; }
    .red { background: var(--red); opacity: .5; }
    .blue { background: var(--blue); opacity: .5; }
    .tooltip { position: absolute; pointer-events: none; background: rgba(0,0,0,.78); color: #fff; padding: 6px 8px; border-radius: 6px; font-size: 12px; z-index: 10; }
    .info { background: #f3f6fa; border: 1px solid #e1e7ef; border-radius: 8px; padding: 10px 14px; color: #243246; font-size: 14px; margin: 8px 0 12px; }
    .correlation-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .corr-strong { background: #dcfce7; color: #166534; }
    .corr-moderate { background: #fef3c7; color: #854d0e; }
    .corr-weak { background: #fee2e2; color: #991b1b; }
    .help-icon { display: inline-block; width: 16px; height: 16px; border-radius: 50%; background: #3b82f6; color: white; text-align: center; line-height: 16px; font-size: 11px; font-weight: bold; margin-left: 8px; cursor: help; vertical-align: middle; }
    .metric-tooltip { position: absolute; pointer-events: none; background: rgba(30,64,175,.95); color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 100; max-width: 350px; line-height: 1.5; box-shadow: 0 4px 6px rgba(0,0,0,.3); }
  </style>
  <script>
    async function tryCsv(paths) {
      let lastErr;
      for (const p of paths) {
        try { return await d3.csv(p, d3.autoType); } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Unable to load CSV: ' + paths.join(', '));
    }

    function fmt1(x) { return d3.format('.1f')(x); }
    function fmt2(x) { return d3.format('.2f')(x); }
    function fmt3(x) { return d3.format('.3f')(x); }
    function toPct(x) { return d3.format('.1%')(x); }
    function toPct0(x) { return d3.format('.0%')(x); }

    function regression(points) {
      let n = 0, sx = 0, sy = 0, sxy = 0, sxx = 0, syy = 0;
      for (const [x0, y0] of points) {
        const x = +x0, y = +y0;
        if (!Number.isFinite(x) || !Number.isFinite(y)) continue;
        n++; sx += x; sy += y; sxy += x*y; sxx += x*x; syy += y*y;
      }
      if (n < 2) return { m: 0, b: sy / (n || 1), r2: 0 };
      const denom = n * sxx - sx * sx;
      const m = denom !== 0 ? (n * sxy - sx * sy) / denom : 0;
      const b = (sy - m * sx) / n;
      
      const ssr = points.reduce((sum, [x0, y0]) => {
        const x = +x0, y = +y0;
        if (!Number.isFinite(x) || !Number.isFinite(y)) return sum;
        return sum + Math.pow(y - (m * x + b), 2);
      }, 0);
      const sst = syy - (sy * sy) / n;
      const r2 = sst !== 0 ? Math.max(0, 1 - ssr / sst) : 0;
      
      return { m, b, r2 };
    }

    async function loadData() {
      const stats = await tryCsv([
        '../output/team_player_usage.csv',
        'output/team_player_usage.csv',
        '/output/team_player_usage.csv'
      ]);

      for (const row of stats) {
        row.logoUrl = (row.logoId !== '' && row.logoId != null) ? 
          `https://cdn.neonsportz.com/teamlogos/256/${row.logoId}.png` : null;
      }

      return stats;
    }

    function drawScatter(holder, rows, cfg) {
      rows = rows.filter(d => 
        Number.isFinite(+d[cfg.xKey]) && Number.isFinite(+d[cfg.yKey])
      );

      if (rows.length < 2) return;

      const margin = { top: 20, right: 24, bottom: 46, left: 70 };
      const width = 1080, height = 480;
      const innerW = width - margin.left - margin.right;
      const innerH = height - margin.top - margin.bottom;

      const panel = holder.append('details').attr('class', 'panel').attr('open', true);
      const summary = panel.append('summary');
      summary.append('span').text(cfg.title);
      
      if (cfg.metricHelp) {
        const helpIcon = summary.append('span').attr('class', 'help-icon').text('?');
        const metricTip = d3.select('body').append('div').attr('class', 'metric-tooltip').style('display', 'none');
        helpIcon.on('mouseenter', function(evt) {
          metricTip.style('display', 'block').html(cfg.metricHelp);
        }).on('mousemove', (evt) => {
          metricTip.style('left', (evt.pageX + 12) + 'px').style('top', (evt.pageY - 28) + 'px');
        }).on('mouseleave', () => {
          metricTip.style('display', 'none');
        });
      }
      
      const wrap = panel.append('div').attr('class', 'chart-wrap');
      const svg = wrap.append('svg').attr('width', width).attr('height', height);
      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const yVals = rows.map(d => +d[cfg.yKey]);
      const yMin = d3.min(yVals), yMax = d3.max(yVals);
      const yRange = yMax - yMin;
      const yPad = yRange * 0.15 || 0.5;
      const y = d3.scaleLinear()
        .domain([yMin - yPad, yMax + yPad])
        .range([innerH, 0]);

      const xVals = rows.map(d => +d[cfg.xKey]);
      const xMin = d3.min(xVals), xMax = d3.max(xVals);
      const xRange = xMax - xMin;
      const xPad = xRange * 0.15 || 0.5;
      const x = d3.scaleLinear()
        .domain([xMin - xPad, xMax + xPad])
        .range([0, innerW]);

      g.append('g').attr('transform', `translate(0,${innerH})`)
        .call(d3.axisBottom(x).ticks(10).tickFormat(cfg.xFormat || fmt2).tickSize(-innerH).tickPadding(8))
        .call(s => s.selectAll('.tick line').attr('stroke', '#e2e2e2'))
        .call(s => s.select('.domain').attr('stroke', '#9aa0a6'));

      g.append('g')
        .call(d3.axisLeft(y).ticks(10).tickFormat(cfg.yFormat || fmt2).tickSize(-innerW).tickPadding(6))
        .call(s => s.selectAll('.tick line').attr('stroke', '#efefef'))
        .call(s => s.select('.domain').attr('stroke', '#dcdcdc'));

      const yAvg = d3.mean(yVals), xAvg = d3.mean(xVals);
      g.append('line').attr('x1', 0).attr('x2', innerW).attr('y1', y(yAvg)).attr('y2', y(yAvg))
        .attr('stroke', '#999').attr('stroke-dasharray', '6,4').attr('stroke-width', 1.5);
      g.append('line').attr('x1', x(xAvg)).attr('x2', x(xAvg)).attr('y1', 0).attr('y2', innerH)
        .attr('stroke', '#9aa0a6').attr('stroke-dasharray', '6,4').attr('stroke-width', 1.5);
      g.append('text').attr('x', 6).attr('y', y(yAvg)-6).attr('fill', '#555').attr('font-size', 11)
        .text('Avg Y: ' + (cfg.yFormat || fmt2)(yAvg));
      g.append('text').attr('x', x(xAvg)+6).attr('y', 12).attr('fill', '#555').attr('font-size', 11)
        .text('Avg X: ' + (cfg.xFormat || fmt2)(xAvg));

      const { m, b, r2 } = regression(rows.map(d => [+d[cfg.xKey], +d[cfg.yKey]]));
      const xRangePts = [d3.min(xVals), d3.max(xVals)];
      g.append('line')
        .attr('x1', x(xRangePts[0])).attr('y1', y(m*xRangePts[0] + b))
        .attr('x2', x(xRangePts[1])).attr('y2', y(m*xRangePts[1] + b))
        .attr('stroke', '#777').attr('stroke-width', 2).attr('opacity', .95);

      const tip = d3.select('body').append('div').attr('class', 'tooltip').style('display', 'none');

      const size = 30;
      const node = g.selectAll('.team').data(rows, d => d.team).join('g').attr('class', 'team')
        .attr('transform', d => `translate(${x(d[cfg.xKey])},${y(d[cfg.yKey])})`)
        .on('mouseenter', function(evt, d){
          const trend = m * d[cfg.xKey] + b;
          const res = d[cfg.yKey] - trend;
          let html = `<strong>${d.team}</strong><br>`;
          html += `${cfg.xLabel}: ${(cfg.xFormat || fmt2)(d[cfg.xKey])}<br>`;
          html += `${cfg.yLabel}: ${(cfg.yFormat || fmt2)(d[cfg.yKey])}<br>`;
          html += `Win%: ${toPct(d.win_pct)}<br>`;
          if (cfg.extraInfo) html += cfg.extraInfo(d) + '<br>';
          html += `Δ vs trend: ${(res>=0?'+':'') + fmt2(res)}<br>`;
          
          const qx = +d[cfg.xKey] >= xAvg;
          const qy = +d[cfg.yKey] >= yAvg;
          let quadrant = '';
          if (cfg.quadrantHelp) {
            if (qx && qy) quadrant = '<em>' + cfg.quadrantHelp.topRight + '</em>';
            else if (!qx && qy) quadrant = '<em>' + cfg.quadrantHelp.topLeft + '</em>';
            else if (!qx && !qy) quadrant = '<em>' + cfg.quadrantHelp.bottomLeft + '</em>';
            else quadrant = '<em>' + cfg.quadrantHelp.bottomRight + '</em>';
          } else {
            if (qx && qy) quadrant = '<em>Правый верхний: высокий X, высокий Y</em>';
            else if (!qx && qy) quadrant = '<em>Левый верхний: низкий X, высокий Y</em>';
            else if (!qx && !qy) quadrant = '<em>Левый нижний: низкий X, низкий Y</em>';
            else quadrant = '<em>Правый нижний: высокий X, низкий Y</em>';
          }
          html += quadrant;
          
          tip.style('display','block').html(html);
        })
        .on('mousemove', (evt)=> tip.style('left', (evt.pageX+12)+'px').style('top',(evt.pageY-28)+'px'))
        .on('mouseleave', ()=> tip.style('display','none'));

      node.append('rect')
        .attr('x', -(size/2 + 2)).attr('y', -(size/2 + 2))
        .attr('width', size + 4).attr('height', size + 4)
        .attr('rx', 4).attr('ry', 4)
        .attr('fill', d => (+d[cfg.yKey] >= m*+d[cfg.xKey] + b) ? 'var(--red)' : 'var(--blue)')
        .attr('opacity', .16);

      node.append('image')
        .attr('href', d => d.logoUrl || null)
        .attr('x', -size/2).attr('y', -size/2)
        .attr('width', size).attr('height', size)
        .attr('opacity', .95);

      svg.append('text').attr('x', margin.left + innerW/2).attr('y', height-10)
        .attr('text-anchor', 'middle').attr('fill', '#444').attr('font-size', 12)
        .text(cfg.xLabel);
      svg.append('text').attr('transform', `translate(14, ${margin.top + innerH/2}) rotate(-90)`)
        .attr('text-anchor', 'middle').attr('fill', '#444').attr('font-size', 12)
        .text(cfg.yLabel);

      const legend = panel.append('div').attr('class', 'legend');
      legend.append('span').html('<span class="swatch red"></span> Above Trend');
      legend.append('span').html('<span class="swatch blue"></span> Below Trend');
      legend.append('span').html('<span class="swatch avg"></span> Average Lines');
      
      let corrClass = 'corr-weak', corrLabel = 'Weak';
      if (r2 >= 0.5) { corrClass = 'corr-strong'; corrLabel = 'Strong'; }
      else if (r2 >= 0.25) { corrClass = 'corr-moderate'; corrLabel = 'Moderate'; }
      
      summary.append('span').attr('class', `correlation-badge ${corrClass}`)
        .style('margin-left', '12px')
        .html(`R²=${fmt3(r2)} (${corrLabel})`);

      if (cfg.insight) {
        panel.append('div').style('padding', '8px 14px 10px').style('font-size', '13px')
          .style('color', '#555').style('font-style', 'italic').text('💡 ' + cfg.insight);
      }
    }

    function render() {
      loadData().then(allRows => {
        const charts = [
          {
            xKey: 'wr1_share',
            yKey: 'win_pct',
            xLabel: 'WR1 Target Share (%)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Star Receiver Dependency',
            insight: 'Do teams need a dominant WR1 to win? Or is spreading the ball better?',
            extraInfo: d => `WR1: ${d.wr1_name} (${d.wr1_position})`,
            metricHelp: '<strong>WR1 Target Share:</strong> Процент передач, брошенных главному WR команды от общего числа передач. Высокий процент (>30%) = зависимость от звезды.',
            quadrantHelp: {
              topRight: '⭐ Звёздная стратегия работает - большая зависимость от WR1 + много побед',
              topLeft: '🎯 Успех через распределение - мяч раскидан, но побед много',
              bottomLeft: '😔 Нет звезды и побед мало - проблемы в пасовой игре',
              bottomRight: '🤔 Парадокс: есть звезда WR1, но мало побед - возможно проблемы в других зонах'
            }
          },
          {
            xKey: 'te_target_share',
            yKey: 'win_pct',
            xLabel: 'TE Target Share (%)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Tight End Usage vs Winning',
            insight: 'Elite TEs are game-changers. Do teams that feature their TE win more?',
            extraInfo: d => `TE1: ${d.te1_name || 'N/A'}`,
            metricHelp: '<strong>TE Target Share:</strong> Процент приёмов тайт-эндом от общего числа приёмов команды. Высокий процент (>20%) = TE как главное оружие в пасовой игре.',
            quadrantHelp: {
              topRight: '⭐ Элитный TE + много побед - тайт-энд как главное оружие работает',
              topLeft: '✅ Побеждают без зависимости от TE - сильные WR или разнообразное нападение',
              bottomLeft: '😔 Мало используют TE + мало побед - упускают важное оружие',
              bottomRight: '🤔 Часто используют TE, но мало побед - возможно проблемы в других позициях'
            }
          },
          {
            xKey: 'rb_target_share',
            yKey: 'win_pct',
            xLabel: 'RB Target Share (% of catches)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Running Back Receiving Usage',
            insight: 'Pass-catching RBs create mismatches. Does featuring RBs in passing game correlate with wins?',
            extraInfo: d => `RB1: ${d.rb1_name}, RB2: ${d.rb2_name || 'N/A'}`,
            metricHelp: '<strong>RB Target Share:</strong> Процент приёмов RB от общего числа приёмов. Высокий процент (>25%) = активное использование RB в пасовой игре или сброс мяча под давлением.',
            quadrantHelp: {
              topRight: '🏃 RB как принимающее оружие + побеждают - современный динамичный стиль работает',
              topLeft: '🎯 Мало RB в пасовой игре + много побед - сильные WR доминируют',
              bottomLeft: '😔 Мало RB в пасовой игре + мало побед - слабое нападение в целом',
              bottomRight: '⚠️ Много передач на RB + мало побед - возможно сброс под давлением, а не стратегия'
            }
          },
          {
            xKey: 'pass_concentration',
            yKey: 'win_pct',
            xLabel: 'Pass Concentration (Herfindahl Index)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Passing Target Distribution',
            insight: 'Concentrated (high) = one star. Spread (low) = balanced. Which strategy wins more?',
            extraInfo: d => `Top 3: ${d.wr1_name}, ${d.wr2_name || 'N/A'}, ${d.wr3_name || 'N/A'}`,
            metricHelp: '<strong>Herfindahl Index:</strong> Индекс концентрации распределения передач (0-10000). >1500 = концентрация на одном игроке, 1000-1500 = баланс, <1000 = равномерное распределение между многими игроками.',
            quadrantHelp: {
              topRight: '⭐ Звёздная стратегия побеждает - концентрация на одном игроке + много побед',
              topLeft: '🎯 Командная игра работает - распределённые передачи + много побед',
              bottomLeft: '😔 Нет звезды + мало побед - слабое нападение без лидера',
              bottomRight: '🤔 Есть звезда, но мало побед - зависимость от одного игрока не окупается'
            }
          },
          {
            xKey: 'rb1_share',
            yKey: 'win_pct',
            xLabel: 'RB1 Rush Share (%)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Bellcow RB vs Committee Approach',
            insight: 'Feature back (70%+) vs RBBC (50-60%). Does workhorse RB strategy win more?',
            extraInfo: d => `RB1: ${d.rb1_name} (${d.rb1_position}) - ${d.rush_distribution_style}`,
            metricHelp: '<strong>RB1 Share:</strong> Процент выносов главного RB от общего числа выносов. >70% = bellcow (основной игрок), 50-60% = RBBC (комитет), <50% = ротация.',
            quadrantHelp: {
              topRight: '💪 Bellcow стратегия работает - основной бегун несёт нагрузку + побеждают',
              topLeft: '🔄 RBBC успех - комитет бегунов + много побед, свежие ноги побеждают',
              bottomLeft: '😔 RBBC + мало побед - нет доминирующего бегуна и результатов',
              bottomRight: '⚠️ Bellcow + мало побед - основной бегун устаёт или команда проигрывает в других зонах'
            }
          },
          {
            xKey: 'top3_share',
            yKey: 'win_pct',
            xLabel: 'Top 3 Receivers Target Share (%)',
            yLabel: 'Win Percentage',
            xFormat: fmt1,
            yFormat: toPct,
            title: 'Top 3 Receiver Dominance',
            insight: 'High concentration in top 3 = star-driven offense. Low = depth & spreading the ball.',
            extraInfo: d => `Top 3: ${d.wr1_name}, ${d.wr2_name || 'N/A'}, ${d.wr3_name || 'N/A'}`,
            metricHelp: '<strong>Top 3 Share:</strong> Суммарный процент приёмов топ-3 принимающих от общего числа. >75% = концентрация на звёздах, <60% = глубокий состав с равномерным распределением.',
            quadrantHelp: {
              topRight: '⭐ Топ-3 доминируют + побеждают - звёздное трио работает отлично',
              topLeft: '🎯 Глубокий состав + много побед - все могут поймать, защита не знает кого крыть',
              bottomLeft: '😔 Нет доминирующих приёмников + мало побед - слабый receiving corps',
              bottomRight: '🤔 Топ-3 доминируют + мало побед - зависимость от 3 игроков слишком предсказуема'
            }
          },
          {
            xKey: 'pass_concentration',
            yKey: 'rush_concentration',
            xLabel: 'Pass Concentration',
            yLabel: 'Rush Concentration',
            xFormat: fmt1,
            title: 'Offensive Philosophy: Concentration Strategy',
            insight: 'Top-right = star-driven (both pass & rush). Bottom-left = committee approach on both.',
            extraInfo: d => `Pass: ${d.wr1_name} | Rush: ${d.rb1_name}`,
            metricHelp: '<strong>Философия нападения:</strong> Сравнение концентрации в пасовой и беговой игре. Верхний правый угол = звёздная тактика, нижний левый = коллективный подход.',
            quadrantHelp: {
              topRight: '⭐ Звёздная философия - зависимость от WR1 и RB1, всё через суперзвёзд',
              topLeft: '🏃 Комитет в беге, звезда в пасе - баланс между ротацией RB и звёздным WR',
              bottomLeft: '🎯 Командный подход - распределение мяча в пасе и в беге, никакой зависимости',
              bottomRight: '🔄 Звезда в пасе, комитет в беге - один WR доминирует, но RB ротируются'
            }
          },
          {
            xKey: 'wr_target_share',
            yKey: 'te_target_share',
            xLabel: 'WR Target Share (%)',
            yLabel: 'TE Target Share (%)',
            xFormat: fmt1,
            title: 'WR vs TE Usage Balance',
            insight: 'WR-heavy offense (high X, low Y) vs TE-heavy (low X, high Y). Strategic preference.',
            extraInfo: d => `WR1: ${d.wr1_name} | TE1: ${d.te1_name || 'N/A'}`,
            metricHelp: '<strong>Баланс WR/TE:</strong> Сравнивает использование широких принимающих (WR) против тайт-эндов (TE). Показывает стратегические предпочтения команды в пасовой игре.',
            quadrantHelp: {
              topRight: '🎯 Идеальный баланс - используют и WR и TE активно, многогранное нападение',
              topLeft: '💪 TE-центричная атака - тайт-энд как главное оружие, WR второстепенны',
              bottomLeft: '🏃 RB-центричный пас - мало WR и TE, возможно много передач на бегунов',
              bottomRight: '🚀 WR-центричная атака - широкие принимающие доминируют, TE роль минимальна'
            }
          },
          {
            xKey: 'wr1_share',
            yKey: 'top3_share',
            xLabel: 'WR1 Share (%)',
            yLabel: 'Top 3 Share (%)',
            xFormat: fmt1,
            title: 'Alpha Receiver vs Supporting Cast',
            insight: 'High both = one star + good #2/#3. High top3, low WR1 = balanced trio.',
            extraInfo: d => `Top 3: ${d.wr1_name}, ${d.wr2_name || 'N/A'}, ${d.wr3_name || 'N/A'}`,
            metricHelp: '<strong>Альфа-приёмник:</strong> Зависимость от WR1 относительно топ-3. Высокие оба значения = одна звезда + хорошие #2/#3. Высокий топ-3, низкий WR1 = сбалансированное трио.',
            quadrantHelp: {
              topRight: '⭐ Альфа + хорошие #2/#3 - одна звезда доминирует, но есть поддержка',
              topLeft: '🎯 Сбалансированное трио - топ-3 сильны, но WR1 не доминирует, равномерное распределение',
              bottomLeft: '😔 Слабый состав приёмников - ни звезды, ни сильной тройки',
              bottomRight: '🤔 WR1 доминирует, слабый топ-3 - вся игра через одного, #2/#3 слабые'
            }
          },
          {
            xKey: 'rb1_share',
            yKey: 'rb2_share',
            xLabel: 'RB1 Rush Share (%)',
            yLabel: 'RB2 Rush Share (%)',
            xFormat: fmt1,
            title: 'Running Back Committee Analysis',
            insight: 'Top-right quadrant = true RBBC (both get work). High X, low Y = clear bellcow.',
            extraInfo: d => `RB1: ${d.rb1_name} | RB2: ${d.rb2_name || 'N/A'}`,
            metricHelp: '<strong>Комитет RB:</strong> Анализ распределения выносов между RB1 и RB2. Верхний правый квадрант = настоящий RBBC (оба получают работу), высокий X низкий Y = явный bellcow.',
            quadrantHelp: {
              topRight: '🔄 Настоящий RBBC - оба бегуна получают работу, 50/50 split или 60/40',
              topLeft: '🤔 RB2 доминирует - возможно травма RB1 или странная ситуация',
              bottomLeft: '😔 Слабая беговая игра - ни RB1 ни RB2 не используются активно',
              bottomRight: '💪 Bellcow доминирует - RB1 получает 70%+ выносов, явный основной игрок'
            }
          },
          {
            xKey: 'wr1_share',
            yKey: 'pass_int_pct',
            xLabel: 'WR1 Target Share (%)',
            yLabel: 'INT Rate (%)',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 Star WR Dependency vs Interception Risk',
            insight: 'Does forcing the ball to one receiver make passing predictable? Check if high WR1 usage = more INTs.',
            metricHelp: '<strong>INT Rate:</strong> Процент перехватов от общего числа передач. Показывает, приводит ли зависимость от одного WR к предсказуемым передачам и перехватам.',
            extraInfo: d => `WR1: ${d.wr1_name} - ${fmt2(d.pass_int_pct)}% INT rate`,
            quadrantHelp: {
              topRight: '😱 Опасная зависимость - много передач на WR1 + много перехватов, предсказуемая игра',
              topLeft: '🎯 Распределение защищает - мяч раскидан + много INT, возможно проблемы QB',
              bottomLeft: '✅ Умная игра - мяч раскидан + мало перехватов, непредсказуемое нападение',
              bottomRight: '⭐ Элитный WR1 - концентрация на звезде, но мало INT, звезда открывается'
            }
          },
          {
            xKey: 'rb1_share',
            yKey: 'rush_broken_tackle_rate',
            xLabel: 'RB1 Rush Share (%)',
            yLabel: 'Broken Tackles per Rush (%)',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 Bellcow Power: Workload vs Physicality',
            insight: 'Do feature backs break more tackles because they\'re elite, or do committees stay fresher?',
            extraInfo: d => `RB1: ${d.rb1_name} - ${fmt2(d.rush_broken_tackle_rate)}% broken tackle rate`,
            quadrantHelp: {
              topRight: '💪 Элитный bellcow - большая нагрузка + ломает захваты, физически доминирующий бегун',
              topLeft: '🔄 Свежие ноги работают - RBBC ломает захваты, ротация даёт силу',
              bottomLeft: '😔 Слабая беговая игра - мало нагрузки + мало broken tackles, проблемы',
              bottomRight: '⚠️ Усталость проявляется - большая нагрузка, но мало broken tackles, бегун устал'
            }
          },
          {
            xKey: 'pass_concentration',
            yKey: 'sack_rate',
            xLabel: 'Pass Concentration Index',
            yLabel: 'Sack Rate (%)',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 Predictability Tax: Target Concentration vs Sacks',
            insight: 'Concentrated passing = defenders know where ball goes = more pressure? Or is it just bad O-lines?',
            extraInfo: d => `WR1: ${d.wr1_name} - ${fmt2(d.sack_rate)}% sack rate`,
            metricHelp: '<strong>Sack Rate:</strong> Процент сэков от (попытки + сэки). Концентрация на одном приёмнике = предсказуемость = больше сэков?',
            quadrantHelp: {
              topRight: '😱 Налог за предсказуемость - концентрация на WR1 + много сэков, защита знает план',
              topLeft: '⚠️ Плохая O-line - мяч раскидан, но много сэков, проблема в защите линии',
              bottomLeft: '✅ Хорошая защита + распределение - мяч раскидан + мало сэков, отлично',
              bottomRight: '⭐ Элитный WR спасает - концентрация на звезде, но мало сэков, быстро открывается'
            }
          },
          {
            xKey: 'te_target_share',
            yKey: 'sack_rate',
            xLabel: 'TE Target Share (%)',
            yLabel: 'Sack Rate (%)',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 TE Usage: Weapon or Safety Blanket?',
            insight: 'High TE usage with low sacks = protection weapon. High TE + high sacks = last resort checkdown.',
            extraInfo: d => `TE1: ${d.te1_name || 'N/A'} - ${fmt2(d.sack_rate)}% sack rate`,
            metricHelp: '<strong>TE + Sacks:</strong> Высокое использование TE с низкими сэками = оружие защиты. Высокие оба = последнее средство под давлением.',
            quadrantHelp: {
              topRight: '⚠️ TE как паника-кнопка - много TE + много сэков, сброс под давлением',
              topLeft: '😔 Плохая O-line без помощи TE - мало TE + много сэков, нужно больше использовать TE',
              bottomLeft: '✅ Не нужен safety blanket - мало TE + мало сэков, хорошая защита линии',
              bottomRight: '💪 TE как оружие - много TE + мало сэков, стратегическое использование тайт-энда'
            }
          },
          {
            xKey: 'top3_share',
            yKey: 'yds_per_play',
            xLabel: 'Top 3 Target Share (%)',
            yLabel: 'Yards per Play',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 Star Power vs Offensive Efficiency',
            insight: 'Elite receivers unlock efficiency? Or does spreading it around keep defenses honest?',
            extraInfo: d => `Top 3: ${d.wr1_name}, ${d.wr2_name || 'N/A'}, ${d.wr3_name || 'N/A'}`,
            metricHelp: '<strong>Yards per Play:</strong> Средние ярды за розыгрыш. Элитные приёмники разблокируют эффективность или распределение мяча держит защиту в напряжении?',
            quadrantHelp: {
              topRight: '⭐ Звёзды разблокируют эффективность - топ-3 доминируют + высокие ярды за розыгрыш',
              topLeft: '🎯 Глубина создаёт эффективность - распределение + высокие ярды, защита в замешательстве',
              bottomLeft: '😔 Слабое нападение - нет звёзд + низкие ярды, проблемы везде',
              bottomRight: '🤔 Звёзды не помогают - топ-3 доминируют, но низкие ярды, предсказуемо'
            }
          },
          {
            xKey: 'rush_concentration',
            yKey: 'rush_yds_per_att',
            xLabel: 'Rush Concentration Index',
            yLabel: 'Rush Yards per Attempt',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 Bellcow Effectiveness Test',
            insight: 'Does feeding one back work? Or do fresh legs from RBBC produce better yards per carry?',
            extraInfo: d => `RB1: ${d.rb1_name} - ${fmt2(d.rush_yds_per_att)} Y/A`,
            metricHelp: '<strong>Rush Y/A:</strong> Ярды за вынос. Проверка эффективности: один бегун vs свежие ноги комитета - кто производит больше ярдов?',
            quadrantHelp: {
              topRight: '💪 Bellcow эффективен - один бегун + высокие ярды за вынос, элитный RB',
              topLeft: '🔄 RBBC работает - свежие ноги + высокие ярды, ротация даёт результат',
              bottomLeft: '😔 Слабая беговая игра - комитет + низкие ярды, нет качественных бегунов',
              bottomRight: '⚠️ Bellcow устаёт - один бегун + низкие ярды, усталость или плохая O-line'
            }
          },
          {
            xKey: 'wr1_share',
            yKey: 'qb_rating',
            xLabel: 'WR1 Target Share (%)',
            yLabel: 'QB Rating',
            xFormat: fmt1,
            yFormat: fmt1,
            title: '💥 Star WR Impact on QB Performance',
            insight: 'Elite WR1 elevates QB play? Or does elite QB make his WR1 look great? Chicken or egg?',
            metricHelp: '<strong>QB Rating:</strong> Рейтинг квотербека. Элитный WR1 повышает игру QB или элитный QB делает WR1 звездой? Курица или яйцо?',
            extraInfo: d => `${d.wr1_name}: ${fmt1(d.wr1_share)}% share → ${fmt1(d.qb_rating)} QB rating`,
            quadrantHelp: {
              topRight: '⭐ WR1 поднимает QB - концентрация на звезде + высокий QB rating, элитный дуэт',
              topLeft: '🎯 QB раскидывает всем - распределение + высокий QB rating, умный квотербек',
              bottomLeft: '😔 Слабая пасовая игра - нет звезды + низкий QB rating, проблемы в пасе',
              bottomRight: '🤔 WR1 не помогает QB - концентрация на звезде, но низкий QB rating, зависимость не работает'
            }
          },
          {
            xKey: 'rb_target_share',
            yKey: 'pass_yds_per_att',
            xLabel: 'RB Target Share (%)',
            yLabel: 'Pass Yards per Attempt',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 RB Checkdown Strategy: Smart or Desperate?',
            insight: 'High RB targets + high Y/A = designed weapon. High RB targets + low Y/A = QB under pressure dumping off.',
            extraInfo: d => `RB1: ${d.rb1_name} - ${fmt2(d.pass_yds_per_att)} Y/A`,
            metricHelp: '<strong>Pass Y/A:</strong> Ярды за попытку паса. Высокие передачи RB + высокий Y/A = оружие. Высокие RB + низкий Y/A = сброс под давлением.',
            quadrantHelp: {
              topRight: '💪 RB как оружие - много передач на RB + высокий Y/A, стратегический mismatches',
              topLeft: '🎯 Эффективный вертикальный пас - мало RB + высокий Y/A, атака через WR/TE',
              bottomLeft: '😔 Слабая пасовая игра - мало RB + низкий Y/A, проблемы по всем позициям',
              bottomRight: '⚠️ Отчаянные сбросы - много RB + низкий Y/A, QB под давлением сбрасывает'
            }
          },
          {
            xKey: 'pass_concentration',
            yKey: 'explosive_plays_per_game',
            xLabel: 'Pass Concentration Index',
            yLabel: 'Explosive Plays (20+) per Game',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 Distribution Strategy vs Big Plays',
            insight: 'Does spreading the ball create more explosive opportunities? Or do stars make the big plays?',
            extraInfo: d => `WR1: ${d.wr1_name} - ${fmt2(d.explosive_plays_per_game)} explosive plays/game`,
            metricHelp: '<strong>Explosive Plays:</strong> Розыгрыши 20+ ярдов за игру. Распределение мяча создаёт больше взрывных моментов или звёзды делают большие игры?',
            quadrantHelp: {
              topRight: '⭐ Звезда делает большие игры - концентрация на WR1 + взрывные розыгрыши, элитный игрок',
              topLeft: '🎯 Глубина создаёт взрывы - распределение + взрывные игры, много угроз',
              bottomLeft: '😔 Нет больших игр - распределение + мало explosive plays, нет playmakers',
              bottomRight: '🤔 Звезда не взрывная - концентрация на WR1, но мало big plays, короткие передачи'
            }
          },
          {
            xKey: 'rush_concentration',
            yKey: 'total_turnovers',
            xLabel: 'Rush Concentration Index',
            yLabel: 'Total Turnovers',
            xFormat: fmt1,
            yFormat: fmt1,
            title: '💥 Ball Security: Bellcow vs Committee',
            insight: 'Feature backs fumble more from fatigue? Or do committees have worse ball security?',
            extraInfo: d => `RB1: ${d.rb1_name} | RB2: ${d.rb2_name || 'N/A'}`,
            metricHelp: '<strong>Turnovers:</strong> Общие потери мяча. Основные бегуны теряют больше от усталости или у комитетов хуже контроль мяча?',
            quadrantHelp: {
              topRight: '😱 Bellcow + много потерь - усталость ведёт к фамблам, большая нагрузка вредит',
              topLeft: '⚠️ Комитет + много потерь - несколько бегунов, но все теряют мяч, общая проблема',
              bottomLeft: '✅ Комитет защищает мяч - свежие ноги + хороший контроль мяча',
              bottomRight: '💪 Bellcow надёжен - большая нагрузка, но мало потерь, элитный контроль мяча'
            }
          },
          {
            xKey: 'wr_target_share',
            yKey: 'pass_td_pct',
            xLabel: 'WR Target Share (%)',
            yLabel: 'Pass TD Rate (%)',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 WR-Heavy Offense Scoring Efficiency',
            insight: 'WR-centric attacks score more TDs? Or are TEs/RBs better in the red zone?',
            extraInfo: d => `WR1: ${d.wr1_name} | TE1: ${d.te1_name || 'N/A'}`,
            metricHelp: '<strong>Pass TD Rate:</strong> Процент тачдаунов от попыток передач. WR-центричные атаки забивают больше TD или TE/RB лучше в красной зоне?',
            quadrantHelp: {
              topRight: '🎯 WR доминируют в red zone - много передач на WR + высокий TD%, эффективно',
              topLeft: '💪 TE/RB забивают TD - мало WR + высокий TD%, tight ends и backs в красной зоне',
              bottomLeft: '😔 Слабая red zone атака - мало WR + низкий TD%, проблемы в scoring',
              bottomRight: '🤔 WR не забивают - много передач на WR, но низкий TD%, неэффективность в red zone'
            }
          },
          {
            xKey: 'te_target_share',
            yKey: 'pass_comp_pct',
            xLabel: 'TE Target Share (%)',
            yLabel: 'Completion Percentage',
            xFormat: fmt1,
            yFormat: fmt1,
            title: '💥 TE Usage: High-Percentage Safety Valve',
            insight: 'TEs are easier throws = higher completion %? Proof that TEs are the ultimate security blanket.',
            extraInfo: d => `TE1: ${d.te1_name || 'N/A'} - ${fmt1(d.pass_comp_pct)}% comp`,
            metricHelp: '<strong>Completion %:</strong> Процент завершённых передач. TE = более лёгкие броски = выше процент? Доказательство, что TE - ultimate подстраховка.',
            quadrantHelp: {
              topRight: '💪 TE как safety valve - много TE + высокий completion%, лёгкие передачи работают',
              topLeft: '🎯 Точный пас без TE - мало TE + высокий completion%, элитный QB или хорошие WR',
              bottomLeft: '😔 Низкая точность без TE - мало TE + низкий completion%, проблемы QB или WR',
              bottomRight: '🤔 TE не помогают - много TE, но низкий completion%, проблема в QB'
            }
          },
          {
            xKey: 'top3_share',
            yKey: 'turnover_diff',
            xLabel: 'Top 3 Target Share (%)',
            yLabel: 'Turnover Differential',
            xFormat: fmt1,
            yFormat: fmt1,
            title: '💥 Star Receivers & Ball Protection',
            insight: 'Elite receivers protect the ball better? Or are teams with top WRs just better overall?',
            extraInfo: d => `Top 3: ${d.wr1_name}, ${d.wr2_name || 'N/A'}, ${d.wr3_name || 'N/A'}`,
            metricHelp: '<strong>Turnover Diff:</strong> Разница потерь мяча (отборы - отдачи). Элитные приёмники лучше защищают мяч или команды с топ-WR просто лучше в целом?',
            quadrantHelp: {
              topRight: '⭐ Звёзды + контроль мяча - топ-3 доминируют + положительный turnover diff, полная команда',
              topLeft: '🎯 Глубина + контроль - распределение + положительный diff, командная игра',
              bottomLeft: '😔 Нет звёзд + теряют мяч - распределение + отрицательный diff, слабая команда',
              bottomRight: '🤔 Звёзды не спасают - топ-3 доминируют, но отрицательный diff, проблемы в других зонах'
            }
          },
          {
            xKey: 'rb1_share',
            yKey: 'rush_td_pct',
            xLabel: 'RB1 Rush Share (%)',
            yLabel: 'Rush TD Rate (%)',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 Goal Line Back: Who Gets the Glory?',
            insight: 'Bellcows dominate goal-line work? Or do committees rotate in fresh power backs for TDs?',
            extraInfo: d => `RB1: ${d.rb1_name} | RB2: ${d.rb2_name || 'N/A'}`,
            metricHelp: '<strong>Rush TD Rate:</strong> Процент тачдаунов от выносов. Bellcow доминируют на линии ворот или комитеты ротируют силовых бегунов для TD?',
            quadrantHelp: {
              topRight: '💪 Bellcow забивает TD - большая нагрузка + высокий TD%, RB1 доминирует в red zone',
              topLeft: '🔄 Goal line specialist - RBBC + высокий TD%, ротируют power back для TDs',
              bottomLeft: '😔 Слабая беговая атака - RBBC + низкий TD%, не забивают на земле',
              bottomRight: '🤔 Bellcow не забивает - большая нагрузка, но низкий TD%, не используют в red zone'
            }
          },
          {
            xKey: 'pass_concentration',
            yKey: 'drop_rate',
            xLabel: 'Pass Concentration Index',
            yLabel: 'Drop Rate (%)',
            xFormat: fmt1,
            yFormat: fmt2,
            title: '💥 Target Overload: Does WR1 Drop More?',
            insight: 'Feeding one receiver = more drops from fatigue? Or do elite WRs have better hands?',
            extraInfo: d => `WR1: ${d.wr1_name} - ${fmt2(d.drop_rate)}% drop rate`,
            metricHelp: '<strong>Drop Rate:</strong> Процент потерянных передач от целей. Кормление одного приёмника = больше потерь от усталости или у элитных WR лучше руки?',
            quadrantHelp: {
              topRight: '😱 Усталость WR1 - концентрация на звезде + высокий drop rate, перегрузка ведёт к ошибкам',
              topLeft: '⚠️ Проблемы с руками - распределение + высокий drop rate, общая проблема corps',
              bottomLeft: '✅ Надёжный corps - распределение + низкий drop rate, все ловят хорошо',
              bottomRight: '⭐ Элитный WR1 - концентрация + низкий drop rate, надёжные руки звезды'
            }
          },
          {
            xKey: 'rb_target_share',
            yKey: 'rec_yac_pct',
            xLabel: 'RB Target Share (%)',
            yLabel: 'YAC % (of receiving yards)',
            xFormat: fmt1,
            yFormat: fmt1,
            title: '💥 RB Receptions: YAC Machines or Dump-offs?',
            insight: 'High RB targets + high YAC% = dynamic weapons. High RB + low YAC% = desperation checkdowns at LOS.',
            extraInfo: d => `RB1: ${d.rb1_name} - ${fmt1(d.rec_yac_pct)}% YAC`,
            metricHelp: '<strong>YAC %:</strong> Процент ярдов после приёма. Высокие передачи RB + высокий YAC% = динамичное оружие. Высокий RB + низкий YAC% = сброс на линии.',
            quadrantHelp: {
              topRight: '💪 RB как YAC машина - много передач на RB + высокий YAC%, динамичное оружие',
              topLeft: '🎯 WR создают YAC - мало RB + высокий YAC%, принимающие набирают после приёма',
              bottomLeft: '😔 Низкий YAC везде - мало RB + низкий YAC%, проблемы после приёма',
              bottomRight: '⚠️ Dump-offs на линии - много RB + низкий YAC%, отчаянные сбросы под давлением'
            }
          }
        ];

        const root = d3.select('#root');
        const sel = d3.select('#conf');

        function redraw() {
          const conf = sel.node().value;
          root.selectAll('*').remove();
          const filtered = conf === 'ALL' ? allRows : allRows.filter(d => d.conference === conf);
          charts.forEach(cfg => drawScatter(root, filtered, cfg));
        }

        sel.on('change', redraw);
        redraw();
      });
    }

    document.addEventListener('DOMContentLoaded', render);
  </script>
</head>
<body>
  <div class="container">
    <h1>Team Player Usage Patterns</h1>
    <div class="subtitle">
      25 graphs combining player usage distribution with team performance. Red = above trend, Blue = below trend.
      Reveals star-driven vs committee approaches and their impact on efficiency, turnovers, and scoring.
    </div>
    <div class="controls">
      <label for="conf">Conference:</label>
      <select id="conf">
        <option value="ALL" selected>All Conferences</option>
        <option value="AFC">AFC only</option>
        <option value="NFC">NFC only</option>
      </select>
    </div>
    <div class="info">
      <strong>Usage Patterns Explained:</strong>
      <ul style="margin: 6px 0 0; padding-left: 20px; line-height: 1.6;">
        <li><strong>Star-Driven</strong>: High concentration (Herfindahl > 1500) - One dominant player gets majority of touches</li>
        <li><strong>Balanced</strong>: Moderate concentration (1000-1500) - Feature player with solid supporting cast</li>
        <li><strong>Committee/Spread</strong>: Low concentration (< 1000) - Multiple players share workload evenly</li>
        <li><strong>Bellcow RB</strong>: RB1 gets 70%+ of rushes - Traditional workhorse back</li>
        <li><strong>RBBC (Running Back By Committee)</strong>: RB1 < 60%, RB2 > 25% - Split backfield</li>
      </ul>
    </div>
    <div id="root"></div>
  </div>
</body>
</html>
